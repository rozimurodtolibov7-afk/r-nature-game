<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-Nature: Ultimate Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        /* ASOSIY DIZAYN */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: url('https://img.freepik.com/free-vector/nature-scene-with-river-hills_1308-51364.jpg?w=1380') no-repeat center center fixed; 
            background-size: cover; overflow: hidden; height: 100vh;
        }
        
        /* EKRANLAR */
        #lang-screen, #menu-screen, #garden-list-screen, #game-screen { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }

        /* UI ELEMENTLARI */
        .pill { background: rgba(255, 255, 255, 0.95); padding: 10px 18px; border-radius: 25px; border: 2px solid #4CAF50; font-weight: 900; font-size: 14px; margin: 5px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .top-ui { position: absolute; top: 10px; width: 100%; padding: 0 15px; z-index: 1100; }
        .stats-container { display: flex; justify-content: space-between; align-items: center; }
        .energy-bar-wrap { width: 100%; height: 12px; background: rgba(0,0,0,0.3); border-radius: 6px; margin-top: 8px; overflow: hidden; border: 1px solid #fff; }
        #energy-fill { height: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); width: 100%; transition: 0.4s; }

        /* BOG'LAR RO'YXATI */
        .list-container { background: rgba(255, 255, 255, 0.9); width: 85%; border-radius: 25px; padding: 20px; max-height: 55vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .garden-item { background: #f1f8e9; padding: 15px; border-radius: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #c5e1a5; font-weight: bold; }

        /* O'YIN MAYDONI */
        #garden-canvas { width: 100%; height: 100%; position: relative; }
        .soil-patch { position: absolute; width: 80px; height: 40px; background: #5d4037; border-radius: 50%; transform: translate(-50%, -50%); z-index: 1; border: 2px solid #3e2723; box-shadow: inset 0 0 10px #000; }
        .plant { position: absolute; transform: translate(-50%, -100%); z-index: 2; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center; }
        
        /* HAYVONLAR VA ZARARKUNANDALAR */
        .enemy { position: absolute; font-size: 45px; z-index: 2000; transition: 6s linear; filter: drop-shadow(2px 2px 5px rgba(0,0,0,0.5)); }
        .drop { position: absolute; font-size: 35px; animation: fall 5s linear forwards; cursor: pointer; z-index: 3000; }

        /* NAVIGATSIYA */
        .bottom-nav { position: absolute; bottom: 30px; display: flex; gap: 15px; z-index: 1100; }
        .nav-icon { width: 65px; height: 65px; background: #fff; border-radius: 20px; border: 3px solid #4CAF50; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* MODAL */
        #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; align-items: center; justify-content: center; padding: 20px; }
        .modal { background: #fff; width: 100%; max-width: 400px; border-radius: 30px; padding: 25px; border: 4px solid #4CAF50; max-height: 80vh; overflow-y: auto; }
        
        @keyframes fall { to { transform: translateY(110vh); } }
    </style>
</head>
<body>

    <div id="lang-screen">
        <h1 style="color:#fff; margin-bottom:30px; text-shadow: 2px 2px #000;">TILNI TANLAN / CHOOSE LANGUAGE</h1>
        <div id="lang-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 85%;"></div>
    </div>

    <div id="menu-screen">
        <h1 style="color:#fff; font-size: 50px; text-shadow: 3px 3px #2e7d32; font-weight: 900;">R-NATURE</h1>
        <button onclick="showGardenList()" style="width:150px; height:150px; border-radius:50%; background:#FFC107; border:8px solid #fff; color:#fff; font-size:28px; font-weight:bold; margin: 40px 0; box-shadow: 0 10px 20px rgba(0,0,0,0.3);">PLAY</button>
        <div style="display:flex; gap:15px;">
            <button class="pill" onclick="openShop()">üõí SHOP</button>
            <button class="pill" onclick="openRank()">üèÜ RANK</button>
        </div>
    </div>

    <div id="garden-list-screen">
        <h2 style="color:white; margin-bottom:20px; text-shadow: 1px 1px #000;">MENING BOG'LARIM</h2>
        <div class="list-container">
            <button class="pill" style="width:100%; background:#4CAF50; color:white; margin-bottom:15px;" onclick="createNewGarden()">+ YANGI BOG' (500 RC)</button>
            <div id="gardens-container"></div>
        </div>
        <button class="pill" style="margin-top:25px; background:#f44336; color:#fff;" onclick="location.reload()">üè† ORQAGA</button>
    </div>

    <div id="game-screen">
        <div class="top-ui">
            <div class="stats-container">
                <div class="pill" onclick="showGardenList()">üîô</div>
                <div class="pill">üí∞ <span id="u-bal">150</span> RC</div>
                <div class="pill">‚ö° <span id="u-nrg">100</span></div>
            </div>
            <div class="energy-bar-wrap"><div id="energy-fill"></div></div>
            <div style="font-size:12px; color:#fff; font-weight:bold; margin-top:5px; text-shadow:1px 1px #000; display:flex; justify-content:space-between;">
                <span>üî´ MILTIQ: <span id="u-gun">0</span></span>
                <span>üíß SUV: <span id="u-water">20</span>%</span>
            </div>
        </div>
        <div id="garden-canvas"></div>
        <div class="bottom-nav">
            <div class="nav-icon" onclick="openInv()">üéí</div>
            <div class="nav-icon" onclick="openShop()">üõí</div>
            <div class="nav-icon" onclick="inviteFriends()">üë•</div>
            <div class="nav-icon" onclick="startRain()">üåßÔ∏è</div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal">
            <h2 id="modal-title" style="text-align:center; color:#2e7d32;"></h2>
            <div id="modal-content" style="margin-top:20px;"></div>
            <button class="pill" style="width:100%; margin-top:20px; border-color:#f44336; color:#f44336;" onclick="closeModal()">YOPISH</button>
        </div>
    </div>

<script>
    // --- KONFIGURATSIYA VA BAZA ---
    const firebaseConfig = { databaseURL: "https://r-nature-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tg = window.Telegram.WebApp;
    const uid = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "user_" + Math.floor(Math.random()*9999);

    let u = {
        bal: 150, nrg: 100, water: 20, lang: null, 
        gardens: [{ name: "Asosiy Bog'", plants: [] }],
        currentIdx: 0, inv: {"Rose": 1},
        items: { gun: 0 }, lastDaily: 0,
        name: tg.initDataUnsafe.user?.first_name || "O'yinchi"
    };

    const shopItems = [
        { id: "Rose", n: "Atirgul", p: 15, i: "üåπ", t: 60 },
        { id: "Sunf", n: "Kungaboqar", p: 45, i: "üåª", t: 150 },
        { id: "Cactus", n: "Kaktus", p: 80, i: "üåµ", t: 300 },
        { id: "gun", n: "Miltiq (Rifle)", p: 100, i: "üî´" }
    ];

    // --- INITIALIZATSIYA ---
    function init() {
        const grid = document.getElementById('lang-grid');
        const langs = { uz: "O'zbek", en: "English", ru: "–†—É—Å—Å–∫–∏–π", tr: "T√ºrk√ße", tj: "–¢–æ“∑–∏–∫”£", de: "Deutsch", fr: "Fran√ßais", es: "Espa√±ol", pt: "Portugu√™s", it: "Italiano" };
        
        Object.keys(langs).forEach(code => {
            const btn = document.createElement('button');
            btn.className = 'pill'; btn.innerText = langs[code];
            btn.onclick = () => { u.lang = code; save(); checkScreen(); };
            grid.appendChild(btn);
        });

        db.ref('users/' + uid).once('value', s => {
            if (s.exists()) {
                u = {...u, ...s.val()};
            }
            checkScreen();
        });

        setInterval(gameTick, 1000);
        setInterval(() => { if(u.nrg < 100) { u.nrg += 1; updateUI(); }}, 60000); // Har minutda energiya
    }

    function checkScreen() {
        document.getElementById('lang-screen').style.display = u.lang ? 'none' : 'flex';
        document.getElementById('menu-screen').style.display = u.lang ? 'flex' : 'none';
        updateUI();
    }

    // --- O'YIN MANTIQI ---
    function gameTick() {
        if(document.getElementById('game-screen').style.display === 'flex') {
            renderPlants();
            // Zararkunandalar chiqishi
            if(Math.random() < 0.005) spawnEnemy('worm');
            if(Math.random() < 0.003) spawnEnemy('crow');
            if(Math.random() < 0.002) spawnEnemy('fox');
        }
    }

    function showGardenList() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('garden-list-screen').style.display = 'flex';
        const container = document.getElementById('gardens-container');
        container.innerHTML = "";
        u.gardens.forEach((g, i) => {
            const div = document.createElement('div');
            div.className = 'garden-item';
            div.innerHTML = `<span>üè° ${g.name}</span> <span>${g.plants?.length || 0} ta o'simlik</span>`;
            div.onclick = () => { u.currentIdx = i; enterGarden(); };
            container.appendChild(div);
        });
    }

    function createNewGarden() {
        if(u.bal >= 500) {
            u.bal -= 500;
            u.gardens.push({ name: "Yangi Bog' " + (u.gardens.length + 1), plants: [] });
            save(); showGardenList();
            tg.showAlert("Yangi bog' ochildi! üéä");
        } else tg.showAlert("RC yetarli emas! (500 kerak)");
    }

    function enterGarden() {
        document.getElementById('garden-list-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        updateUI();
    }

    function updateUI() {
        document.getElementById('u-bal').innerText = Math.floor(u.bal);
        document.getElementById('u-nrg').innerText = Math.floor(u.nrg);
        document.getElementById('u-gun').innerText = u.items.gun || 0;
        document.getElementById('u-water').innerText = u.water;
        document.getElementById('energy-fill').style.width = u.nrg + "%";
    }

    function renderPlants() {
        const canvas = document.getElementById('garden-canvas');
        canvas.innerHTML = "";
        const g = u.gardens[u.currentIdx];
        if(!g.plants) g.plants = [];
        
        g.plants.forEach((p, i) => {
            const it = shopItems.find(x => x.id === p.id);
            const age = (Date.now() - p.t) / 1000;

            // Tuproq maydoni (Faqat ekilgan joyda)
            const patch = document.createElement('div');
            patch.className = 'soil-patch'; 
            patch.style.left = p.x + 'px'; patch.style.top = p.y + 'px';
            canvas.appendChild(patch);

            // O'simlik
            const plant = document.createElement('div');
            plant.className = 'plant'; 
            plant.style.left = p.x + 'px'; plant.style.top = p.y + 'px';
            
            if (age >= it.t) {
                plant.innerHTML = `<div style="position:absolute;top:-45px;background:#4CAF50;color:#fff;font-size:10px;padding:2px 8px;border-radius:10px;">HOSIL</div>${it.i}`;
                plant.style.fontSize = "55px";
                plant.onclick = () => collect(i);
            } else if (age < 10) { 
                // KICHKINA KO'CHAT
                plant.innerText = "üå±";
                plant.style.fontSize = "25px";
                plant.style.opacity = "0.7";
            } else {
                // O'SAYOTGAN O'SIMLIK
                plant.innerText = age > it.t/2 ? "üåø" : "üå±";
                plant.style.fontSize = "42px";
            }
            canvas.appendChild(plant);
        });
    }

    document.getElementById('garden-canvas').onclick = (e) => {
        if(e.target !== e.currentTarget) return;
        if(!window.selectedSeed || u.inv[window.selectedSeed] <= 0) return;
        if(u.nrg < 10) { tg.showAlert("Energiya kam!"); return; }

        u.gardens[u.currentIdx].plants.push({
            id: window.selectedSeed, x: e.clientX, y: e.clientY, t: Date.now()
        });
        u.inv[window.selectedSeed]--;
        u.nrg -= 10;
        save(); updateUI(); renderPlants();
    };

    function collect(i) {
        const p = u.gardens[u.currentIdx].plants[i];
        const it = shopItems.find(x => x.id === p.id);
        u.bal += it.p * 2.5;
        u.gardens[u.currentIdx].plants.splice(i, 1);
        save(); updateUI(); renderPlants();
    }

    // --- QO'SHIMCHA FUNKSIYALAR ---
    function inviteFriends() {
        const shareLink = `https://t.me/share/url?url=https://t.me/RPlay_game_bot?start=${uid}&text=Men bilan o'yna!`;
        tg.openTelegramLink(shareLink);
        
        // BONUS BERISH
        u.bal += 10;
        save(); updateUI();
        tg.showAlert("Do'stga taklif yuborildi! +10 RC berildi üéÅ");
    }

    function spawnEnemy(type) {
        const e = document.createElement('div'); e.className = 'enemy';
        const icons = { worm: "üêõ", crow: "üê¶‚Äç‚¨õ", fox: "ü¶ä" };
        e.innerText = icons[type];
        e.style.top = Math.random()*70+15+"%"; e.style.left = "-60px";
        document.body.appendChild(e);

        if(type === 'worm') {
            e.onclick = () => {
                if(u.items.gun > 0) { u.items.gun--; e.remove(); updateUI(); save(); }
                else tg.showAlert("Miltiq kerak! üî´");
            };
        } else {
            e.onclick = () => { e.remove(); u.bal += 5; updateUI(); };
        }

        setTimeout(() => {
            e.style.left = "110%";
            setTimeout(() => {
                if(e.parentNode) {
                    if(u.gardens[u.currentIdx].plants.length > 0) {
                        u.gardens[u.currentIdx].plants.splice(0, 1);
                        tg.showAlert(type === 'fox' ? "Tulki o'g'irladi! ü¶ä" : "Qarg'a yedi! üê¶‚Äç‚¨õ");
                    }
                    e.remove(); renderPlants();
                }
            }, 6000);
        }, 100);
    }

    function startRain() {
        tg.showAlert("Yomg'ir yog'moqda! Tomchilarni tuting üíß");
        const interval = setInterval(() => {
            const d = document.createElement('div'); d.className = 'drop'; d.innerText = "üíß";
            d.style.left = Math.random()*90+"%"; d.style.top = "-50px";
            document.body.appendChild(d);
            d.onclick = () => { u.water = Math.min(100, u.water + 5); updateUI(); d.remove(); };
            setTimeout(() => { if(d.parentNode) d.remove(); }, 5000);
        }, 1500); // Yomg'ir sekinroq
        setTimeout(() => clearInterval(interval), 10000);
    }

    function openInv() {
        document.getElementById('modal-title').innerText = "üéí SANDIQ";
        let h = "";
        for(let k in u.inv) if(u.inv[k]>0) {
            h += `<div class="garden-item"><span>${k} (x${u.inv[k]})</span> <button class="pill" onclick="selectSeed('${k}')">EKISH</button></div>`;
        }
        document.getElementById('modal-content').innerHTML = h || "Sandiq bo'sh";
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.selectSeed = (id) => { window.selectedSeed = id; closeModal(); tg.showAlert("Yerni bosing!"); };

    function openShop() {
        document.getElementById('modal-title').innerText = "üõí DO'KON";
        document.getElementById('modal-content').innerHTML = shopItems.map(it => `
            <div class="garden-item"><span>${it.i} ${it.n} (${it.p} RC)</span> <button class="pill" onclick="buy('${it.id}')">SOTIB OLISH</button></div>
        `).join('');
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.buy = (id) => {
        const it = shopItems.find(x => x.id === id);
        if(u.bal >= it.p) { 
            u.bal -= it.p; 
            if(id === 'gun') u.items.gun = (u.items.gun||0)+1;
            else u.inv[id] = (u.inv[id]||0)+1;
            save(); updateUI(); tg.showAlert("Sotib olindi! ‚úÖ");
        } else tg.showAlert("Mablag' yetarli emas!");
    };

    function openRank() {
        db.ref('users').orderByChild('bal').limitToLast(10).once('value', s => {
            let list = []; s.forEach(c => list.push(c.val()));
            list.reverse();
            document.getElementById('modal-title').innerText = "üèÜ REYTING";
            document.getElementById('modal-content').innerHTML = list.map((p, i) => `
                <div class="garden-item"><span>${i+1}. ${p.name}</span> <b>${Math.floor(p.bal)} RC</b></div>
            `).join('');
            document.getElementById('modal-overlay').style.display = 'flex';
        });
    }

    function save() { db.ref('users/' + uid).set(u); }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    init();
</script>
</body>
</html>