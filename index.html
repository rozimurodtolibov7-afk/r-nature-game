<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-Nature: Definitive Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { 
            font-family: 'Arial', sans-serif; 
            background: #4caf50; 
            overflow: hidden; height: 100vh;
        }
        
        #lang-screen, #menu-screen, #garden-list-screen, #game-screen { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }

        .pill { background: white; padding: 12px 24px; border-radius: 30px; border: 3px solid #2e7d32; font-weight: bold; color: #2e7d32; cursor: pointer; box-shadow: 0 4px 0 #2e7d32; margin: 5px; }
        .pill:active { transform: translateY(2px); box-shadow: 0 2px 0 #2e7d32; }

        .top-ui { position: absolute; top: 10px; width: 100%; padding: 0 15px; z-index: 1100; pointer-events: none; }
        .top-ui * { pointer-events: auto; }

        #garden-canvas { width: 100%; height: 100%; position: relative; background: url('https://img.freepik.com/free-vector/spring-landscape-scene_23-2148852379.jpg') center bottom/cover; }
        
        .soil-patch { position: absolute; width: 80px; height: 40px; background: #5d4037; border-radius: 50%; transform: translate(-50%, -50%); z-index: 1; border: 2px solid #3e2723; }
        .plant { position: absolute; transform: translate(-50%, -100%); z-index: 2; transition: all 0.5s ease; cursor: pointer; }

        /* Miltiq - doimiy o'ng burchakda */
        #gun-container { 
            position: absolute; bottom: 100px; right: 40px; width: 80px; height: 80px; 
            z-index: 5000; pointer-events: none; display: flex; align-items: center; justify-content: center;
        }
        #gun-visual { font-size: 60px; transform-origin: center center; }

        .enemy { position: absolute; font-size: 50px; z-index: 2000; transition: left 8s linear; pointer-events: auto; cursor: crosshair; }
        .drop { position: absolute; font-size: 40px; animation: fall 4s linear forwards; cursor: pointer; z-index: 3000; }

        @keyframes fall { to { transform: translateY(110vh); } }
        @keyframes kickback { 0% { transform: scale(1); } 50% { transform: scale(1.4) translateX(10px); } 100% { transform: scale(1); } }
        .shooting { animation: kickback 0.1s ease; }

        .list-container { background: white; width: 85%; border-radius: 20px; padding: 20px; border: 4px solid #2e7d32; max-height: 50vh; overflow-y: auto; }
        .garden-row { background: #f0f0f0; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-radius: 10px; }

        #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 6000; align-items: center; justify-content: center; }
        .modal { background: white; width: 90%; border-radius: 20px; padding: 20px; }
    </style>
</head>
<body>

    <div id="lang-screen">
        <h1 style="color:white; margin-bottom:20px; text-shadow: 2px 2px #000;">CHOOSE LANGUAGE</h1>
        <div id="lang-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
    </div>

    <div id="menu-screen">
        <h1 style="color:white; font-size: 50px; text-shadow: 3px 3px #2e7d32;">R-NATURE</h1>
        <button onclick="showGardenList()" style="width:140px; height:140px; border-radius:50%; background:#FFC107; border:8px solid #fff; color:white; font-size:25px; font-weight:bold; margin: 30px 0;">PLAY</button>
        <button class="pill" onclick="openShop()">üõí SHOP</button>
    </div>

    <div id="garden-list-screen">
        <h2 style="color:white; margin-bottom:15px;">MY GARDENS</h2>
        <div class="list-container">
            <div id="gardens-container"></div>
        </div>
        <button class="pill" style="margin-top:20px; background:#4CAF50; color:white;" onclick="createNewGarden()">+ ADD FREE GARDEN</button>
        <button class="pill" onclick="location.reload()">üè† BACK</button>
    </div>

    <div id="game-screen">
        <div class="top-ui">
            <div style="display:flex; justify-content:space-between;">
                <button class="pill" onclick="showGardenList()">üîô</button>
                <div class="pill">üí∞ <span id="u-bal">0</span> RC</div>
                <div class="pill">‚ö° <span id="u-nrg">0</span></div>
            </div>
            <div style="color:white; font-weight:bold; text-shadow:1px 1px #000; margin-top:5px;">
                üî´ AMMO: UNLIMITED | üíß WATER: <span id="u-water">0</span>
            </div>
        </div>

        <div id="garden-canvas"></div>
        
        <div id="gun-container">
            <div id="gun-visual">üî´</div>
        </div>

        <div style="position:absolute; bottom:20px; display:flex; gap:10px; z-index:1100;">
            <button class="pill" onclick="openInv()">üéí</button>
            <button class="pill" onclick="openShop()">üõí</button>
            <button class="pill" onclick="inviteFriends()">üë• +10RC</button>
            <button class="pill" onclick="startRain()">üåßÔ∏è</button>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal">
            <h2 id="modal-title" style="text-align:center;"></h2>
            <div id="modal-content" style="margin-top:15px;"></div>
            <button class="pill" style="width:100%; margin-top:15px;" onclick="closeModal()">CLOSE</button>
        </div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://r-nature-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tg = window.Telegram.WebApp;
    const uid = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "local_tester";

    let u = {
        bal: 150, nrg: 100, water: 0, lang: null, 
        gardens: [{ name: "Main Garden", plants: [] }],
        currentIdx: 0, inv: {"Rose": 5}
    };

    const shopItems = [
        { id: "Rose", n: "Rose", p: 10, i: "üåπ", t: 30 },
        { id: "Sunf", n: "Sunflower", p: 40, i: "üåª", t: 100 },
        { id: "Tree", n: "Apple Tree", p: 150, i: "üçé", t: 300 }
    ];

    function init() {
        const grid = document.getElementById('lang-grid');
        ["UZ", "EN", "RU", "TR", "TJ", "FR", "DE", "ES", "IT", "PT"].forEach(l => {
            const b = document.createElement('button'); b.className = 'pill'; b.innerText = l;
            b.onclick = () => { u.lang = l; save(); checkScreen(); };
            grid.appendChild(b);
        });

        db.ref('users/' + uid).once('value', s => {
            if (s.exists()) u = {...u, ...s.val()};
            checkScreen();
        });

        setInterval(gameTick, 1000);
        
        // Miltiqni aylantirish - Aniq mantiq
        const handleMove = (e) => {
            if(document.getElementById('game-screen').style.display !== 'flex') return;
            const gun = document.getElementById('gun-visual');
            const rect = gun.getBoundingClientRect();
            const gunX = rect.left + rect.width / 2;
            const gunY = rect.top + rect.height / 2;
            const mouseX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const mouseY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            
            const angle = Math.atan2(mouseY - gunY, mouseX - gunX);
            gun.style.transform = `rotate(${angle}rad)`;
        };

        window.addEventListener('mousemove', handleMove);
        window.addEventListener('touchmove', handleMove);
    }

    function checkScreen() {
        document.getElementById('lang-screen').style.display = u.lang ? 'none' : 'flex';
        document.getElementById('menu-screen').style.display = u.lang ? 'flex' : 'none';
        updateUI();
    }

    function gameTick() {
        if(document.getElementById('game-screen').style.display === 'flex') {
            renderPlants();
            // Zararkunandalar chiqish ehtimoli
            if(Math.random() < 0.02) spawnEnemy();
        }
    }

    function showGardenList() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('garden-list-screen').style.display = 'flex';
        const container = document.getElementById('gardens-container'); container.innerHTML = "";
        u.gardens.forEach((g, i) => {
            const d = document.createElement('div'); d.className = 'garden-row';
            d.innerHTML = `<span>üè° ${g.name}</span> <button class="pill" onclick="u.currentIdx=${i}; enterGarden()">GO</button>`;
            container.appendChild(d);
        });
    }

    function createNewGarden() {
        u.gardens.push({ name: "Garden " + (u.gardens.length + 1), plants: [] });
        save(); showGardenList();
    }

    function enterGarden() {
        document.getElementById('garden-list-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        updateUI();
    }

    function updateUI() {
        document.getElementById('u-bal').innerText = Math.floor(u.bal);
        document.getElementById('u-nrg').innerText = Math.floor(u.nrg);
        document.getElementById('u-water').innerText = u.water;
    }

    function renderPlants() {
        const canvas = document.getElementById('garden-canvas'); canvas.innerHTML = "";
        const g = u.gardens[u.currentIdx];
        if(!g.plants) g.plants = [];
        
        g.plants.forEach((p, i) => {
            const it = shopItems.find(x => x.id === p.id);
            const age = (Date.now() - p.t) / 1000;
            
            // Tuproq
            const patch = document.createElement('div');
            patch.className = 'soil-patch'; patch.style.left = p.x+'px'; patch.style.top = p.y+'px';
            canvas.appendChild(patch);

            // O'simlik bosqichlari
            const pl = document.createElement('div');
            pl.className = 'plant'; pl.style.left = p.x+'px'; pl.style.top = p.y+'px';
            
            if (age >= it.t) {
                pl.innerHTML = `<div style="font-size:10px;background:gold;padding:2px;border-radius:5px;">READY</div>${it.i}`;
                pl.style.fontSize = "50px";
                pl.onclick = (e) => { e.stopPropagation(); u.bal += it.p*3; g.plants.splice(i,1); save(); updateUI(); };
            } else if (age < 7) {
                pl.innerText = "üå±"; pl.style.fontSize = "20px"; // Urug'
            } else if (age < it.t / 2) {
                pl.innerText = "üåø"; pl.style.fontSize = "35px"; // Maysa
            } else {
                pl.innerText = "üå≥"; pl.style.fontSize = "45px"; // Daraxt
            }
            canvas.appendChild(pl);
        });
    }

    document.getElementById('garden-canvas').onclick = (e) => {
        if(window.selectedSeed && u.inv[window.selectedSeed] > 0) {
            u.gardens[u.currentIdx].plants.push({id: window.selectedSeed, x: e.clientX, y: e.clientY, t: Date.now()});
            u.inv[window.selectedSeed]--;
            save(); renderPlants();
        }
    };

    function spawnEnemy() {
        const e = document.createElement('div'); e.className = 'enemy';
        const types = ["üêõ", "üê¶‚Äç‚¨õ", "ü¶ä"];
        e.innerText = types[Math.floor(Math.random()*types.length)];
        e.style.top = (Math.random()*60 + 20) + "%";
        e.style.left = "-60px";
        document.body.appendChild(e);

        // Miltiqdan otish mantiqi
        e.onclick = (ev) => {
            ev.stopPropagation();
            const gun = document.getElementById('gun-visual');
            gun.classList.add('shooting');
            setTimeout(() => gun.classList.remove('shooting'), 100);
            e.remove();
            u.bal += 5; updateUI(); // Har bir hayvon uchun 5 RC
        };

        // Hayvonning harakati
        setTimeout(() => {
            e.style.left = "110%";
            setTimeout(() => {
                if(e.parentNode) {
                    e.remove();
                    if(u.gardens[u.currentIdx].plants.length > 0) {
                        u.gardens[u.currentIdx].plants.shift(); // Hayvon o'simlikni yedi
                        renderPlants();
                    }
                }
            }, 8000);
        }, 100);
    }

    function inviteFriends() {
        tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/RPlay_game_bot?start=${uid}`);
        // Telegram share oynasi ochilgandan keyin bonus beriladi
        setTimeout(() => {
            u.bal += 10; save(); updateUI();
            tg.showAlert("Do'st taklif qilganingiz uchun +10 RC! üéÅ");
        }, 500);
    }

    function startRain() {
        tg.showAlert("Yomg'ir! Tomchilarni tuting! üíß = 1 RC");
        const rain = setInterval(() => {
            const d = document.createElement('div'); d.className = 'drop'; d.innerText = "üíß";
            d.style.left = Math.random()*90+"%"; d.style.top = "-50px";
            document.body.appendChild(d);
            d.onclick = () => { u.bal += 1; u.water += 1; updateUI(); d.remove(); };
            setTimeout(() => { if(d.parentNode) d.remove(); }, 4000);
        }, 1000);
        setTimeout(() => clearInterval(rain), 10000);
    }

    function openShop() {
        document.getElementById('modal-title').innerText = "SHOP";
        document.getElementById('modal-content').innerHTML = shopItems.map(it => `
            <div class="garden-row"><span>${it.i} ${it.n} (${it.p} RC)</span> <button class="pill" onclick="buy('${it.id}')">BUY</button></div>
        `).join('');
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.buy = (id) => {
        const it = shopItems.find(x => x.id === id);
        if(u.bal >= it.p) { u.bal -= it.p; u.inv[id] = (u.inv[id]||0)+1; save(); updateUI(); }
    };

    function openInv() {
        document.getElementById('modal-title').innerText = "MY BAG";
        let h = "";
        for(let k in u.inv) if(u.inv[k]>0) h += `<div class="garden-row"><span>${k} (x${u.inv[k]})</span> <button class="pill" onclick="window.selectedSeed='${k}'; closeModal()">SELECT</button></div>`;
        document.getElementById('modal-content').innerHTML = h || "Empty";
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function save() { db.ref('users/' + uid).set(u); }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    init();
</script>
</body>
</html>