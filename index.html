<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-Nature World</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #ffffff; overflow: hidden; color: #333; }
        
        /* EKRANLAR */
        #loading, #lang-screen, #menu-screen, #game-screen { position: fixed; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: white; z-index: 1000; }
        #loading { display: flex; }

        /* UI TOP STATS */
        .top-ui { position: absolute; top: 15px; width: 100%; padding: 0 20px; z-index: 1100; pointer-events: none; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 8px; pointer-events: auto; }
        .pill { background: #f8f9fa; padding: 8px 15px; border-radius: 20px; border: 1.5px solid #eee; font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .energy-wrapper { width: 100%; height: 12px; background: #eee; border-radius: 6px; overflow: hidden; border: 1px solid #ddd; }
        #energy-bar { height: 100%; background: linear-gradient(90deg, #ffcc00, #ffeb3b); width: 100%; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* GARDEN AREA */
        #garden { width: 100%; height: 100%; position: relative; background: #ffffff; cursor: crosshair; }
        .plant { position: absolute; transform: translate(-50%, -100%); font-size: 50px; text-align: center; cursor: pointer; transition: transform 0.2s; }
        .plant:active { transform: translate(-50%, -100%) scale(0.9); }
        .water-req { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); background: #007aff; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; animation: pulse 1s infinite; }
        .profit-tag { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: bold; }

        /* MODALS */
        #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { background: #fff; width: 90%; max-width: 400px; border-radius: 30px; padding: 25px; position: relative; max-height: 80vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; color: #ff3b30; font-weight: bold; background: none; border: none; cursor: pointer; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f0f0f0; }
        
        /* NAVIGATION */
        .nav-bar { position: absolute; bottom: 30px; display: flex; gap: 20px; z-index: 1100; }
        .nav-icon { width: 65px; height: 65px; border-radius: 22px; background: #ffffff; border: 1.5px solid #eee; font-size: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 15px rgba(0,0,0,0.08); cursor: pointer; }

        /* ANIMATIONS */
        @keyframes pulse { 0% { opacity: 0.7; transform: translateX(-50%) scale(1); } 50% { opacity: 1; transform: translateX(-50%) scale(1.1); } 100% { opacity: 0.7; transform: translateX(-50%) scale(1); } }
        
        .pest { position: absolute; font-size: 45px; z-index: 1050; cursor: pointer; transition: 0.3s; animation: wobble 0.5s infinite; }
        @keyframes wobble { 0%, 100% { transform: rotate(-10deg); } 50% { transform: rotate(10deg); } }
    </style>
</head>
<body>

    <div id="loading"><h1>R-NATURE...</h1></div>

    <div id="lang-screen">
        <h2 style="margin-bottom: 25px;">Tilni tanlang / Choose Language</h2>
        <div id="lang-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 90%;"></div>
    </div>

    <div id="menu-screen">
        <h1 style="color: #28a745; margin-bottom: 10px; font-size: 40px; font-weight: 900;">R-NATURE</h1>
        <p style="color: #888; margin-bottom: 30px;">Fermerlik Strategiyasi</p>
        <button onclick="startGame()" style="width: 150px; height: 150px; border-radius: 50%; background: #ffcc00; border: 8px solid #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.1); color: white; font-size: 30px; font-weight: 900; cursor: pointer;">PLAY</button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 85%; margin-top: 40px;">
            <button class="pill" style="justify-content: center; padding: 18px;" onclick="openShop()">üõí Do'kon</button>
            <button class="pill" style="justify-content: center; padding: 18px;" onclick="openRank()">üèÜ Reyting</button>
        </div>
    </div>

    <div id="game-screen">
        <div class="top-ui">
            <div class="stats-row">
                <div class="pill" onclick="goHome()" style="pointer-events: auto;">üè†</div>
                <div class="pill">üí∞ <span id="u-bal">0</span></div>
                <div class="pill">‚ö° <span id="u-nrg">0</span>/100</div>
            </div>
            <div class="energy-wrapper"><div id="energy-bar"></div></div>
        </div>

        <div id="garden"></div>

        <div class="nav-bar">
            <div class="nav-icon" onclick="openInv()">üéí</div>
            <div class="nav-icon" onclick="openShop()" style="color: #007aff;">üõí</div>
            <div class="nav-icon" onclick="invite()">üë•</div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal">
            <button class="close-btn" onclick="closeModal()">‚úï</button>
            <h2 id="m-title" style="text-align: center; margin-bottom: 20px; font-weight: 800;"></h2>
            <div id="m-body"></div>
        </div>
    </div>

<script>
    // FIREBASE INITIALIZATION
    const firebaseConfig = { 
        databaseURL: "https://r-nature-default-rtdb.firebaseio.com/",
        projectId: "r-nature"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tg = window.Telegram.WebApp;
    const uid = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "local_test";

    // GAME STATE
    let u = { 
        bal: 50, nrg: 100, lang: null, inv: {"Rose": 1}, 
        planted: [], lastDaily: 0, lastNrg: Date.now(),
        name: tg.initDataUnsafe.user?.first_name || "Fermer"
    };
    let selectedSeed = null;

    const items = [
        { id: "Rose", n: "Atirgul", p: 10, i: "üåπ", t: 300 }, // 5 min
        { id: "Cactus", n: "Kaktus", p: 25, i: "üåµ", t: 420 }, // 7 min
        { id: "Sunf", n: "Kungaboqar", p: 60, i: "üåª", t: 600 }, // 10 min
        { id: "Magic", n: "Sehrli Daraxt", p: 5000, i: "üå≥", t: 3600 } // 1 soat
    ];

    function init() {
        const langBox = document.getElementById('lang-list');
        const langs = { uz:"O'zbek", en:"English", ru:"–†—É—Å—Å–∫–∏–π", tr:"T√ºrk√ße", tj:"–¢–æ“∑–∏–∫”£", de:"Deutsch", fr:"Fran√ßais", es:"Espa√±ol", pt:"Portugu√™s", it:"Italiano" };
        
        Object.keys(langs).forEach(k => {
            const btn = document.createElement('button');
            btn.className = 'pill'; btn.style.justifyContent = 'center';
            btn.innerText = langs[k];
            btn.onclick = () => { u.lang = k; save(); checkDaily(); showMenu(); };
            langBox.appendChild(btn);
        });

        db.ref('users/' + uid).once('value', s => {
            document.getElementById('loading').style.display = 'none';
            if(s.exists()) {
                u = {...u, ...s.val()};
                if(u.lang) { checkDaily(); showMenu(); } 
                else { document.getElementById('lang-screen').style.display = 'flex'; }
            } else {
                document.getElementById('lang-screen').style.display = 'flex';
            }
        });

        // Loop cycles
        setInterval(tick, 1000);
        setInterval(() => { if(u.nrg < 100) { u.nrg++; updateUI(); save(); } }, 60000); // +1 energy per min
    }

    function checkDaily() {
        const now = Date.now();
        if(now - u.lastDaily > 86400000) {
            u.bal += 20;
            u.lastDaily = now;
            save();
            setTimeout(() => tg.showAlert("Xush kelibsiz! Har kungi sovg'a: 20 RC tabriklaymiz!"), 1000);
        }
    }

    function tick() {
        if(document.getElementById('game-screen').style.display === 'flex') {
            renderGarden();
            // Zararkunanda chiqish ehtimoli (har 30 soniyada 10% imkoniyat)
            if(Math.random() < 0.003 && u.planted.length > 0) spawnPest();
        }
    }

    function showMenu() {
        document.getElementById('lang-screen').style.display = 'none';
        document.getElementById('menu-screen').style.display = 'flex';
        document.getElementById('game-screen').style.display = 'none';
        updateUI();
    }

    function startGame() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        renderGarden();
    }

    function updateUI() {
        document.getElementById('u-bal').innerText = Math.floor(u.bal);
        document.getElementById('u-nrg').innerText = u.nrg;
        document.getElementById('energy-bar').style.width = u.nrg + "%";
    }

    function openShop() {
        document.getElementById('m-title').innerText = "DO'KON";
        let h = "";
        items.forEach(it => {
            h += `<div class="item-row">
                    <span>${it.i} ${it.n} <br><small>${it.p} RC | ${(it.t/60).toFixed(0)} min</small></span>
                    <button class="pill" onclick="buyItem('${it.id}')">Sotib olish</button>
                  </div>`;
        });
        document.getElementById('m-body').innerHTML = h;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.buyItem = (id) => {
        const it = items.find(x => x.id === id);
        if(u.bal >= it.p) {
            u.bal -= it.p;
            u.inv[id] = (u.inv[id] || 0) + 1;
            save(); updateUI();
            tg.HapticFeedback.notificationOccurred('success');
        } else {
            tg.showAlert("RC yetarli emas!");
        }
    };

    function openInv() {
        document.getElementById('m-title').innerText = "SANDIQ";
        let h = "";
        let empty = true;
        for(let key in u.inv) {
            if(u.inv[key] > 0) {
                empty = false;
                const it = items.find(x => x.id === key) || {i:"üì¶", n:key};
                h += `<div class="item-row">
                        <span>${it.i} ${it.n} (x${u.inv[key]})</span>
                        <button class="pill" style="background:#28a745; color:white;" onclick="selectSeed('${key}')">Ekish</button>
                      </div>`;
            }
        }
        document.getElementById('m-body').innerHTML = empty ? "<p style='text-align:center'>Sandiq bo'sh</p>" : h;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.selectSeed = (id) => {
        selectedSeed = id;
        closeModal();
        tg.showAlert("Endi ekranning istalgan joyiga bosing!");
    };

    document.getElementById('garden').onclick = (e) => {
        if(!selectedSeed || u.inv[selectedSeed] <= 0) return;
        if(u.nrg < 10) { tg.showAlert("‚ö° Energiya kam (Kamida 10 kerak)!"); return; }

        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        u.planted.push({
            id: selectedSeed,
            x: x, y: y,
            t: Date.now(),
            w: false // watered
        });

        u.inv[selectedSeed]--;
        u.nrg -= 10;
        save(); updateUI(); renderGarden();
        tg.HapticFeedback.impactOccurred('medium');
    };

    function renderGarden() {
        const g = document.getElementById('garden');
        g.innerHTML = '';
        u.planted.forEach((p, i) => {
            const it = items.find(x => x.id === p.id);
            const age = (Date.now() - p.t) / 1000;
            const div = document.createElement('div');
            div.className = 'plant';
            div.style.left = p.x + 'px'; div.style.top = p.y + 'px';

            if(age >= it.t) {
                div.innerHTML = `<div class="profit-tag">+${it.p * 2} RC</div>${it.i}`;
                div.onclick = (e) => { e.stopPropagation(); collect(i); };
            } else if(!p.w) {
                div.innerHTML = `<div class="water-req">üö∞ Sug'orish</div>ü´ò`;
                div.onclick = (e) => { e.stopPropagation(); water(i); };
            } else {
                div.innerText = age > (it.t / 2) ? "üåø" : "üå±";
            }
            g.appendChild(div);
        });
    }

    function water(i) {
        if(u.nrg < 5) { tg.showAlert("Suv quyish uchun 5‚ö° energiya kerak!"); return; }
        u.planted[i].w = true;
        u.nrg -= 5;
        save(); updateUI(); renderGarden();
        tg.HapticFeedback.impactOccurred('light');
    }

    function collect(i) {
        const p = u.planted[i];
        const it = items.find(x => x.id === p.id);
        u.bal += it.p * 2;
        u.planted.splice(i, 1);
        save(); updateUI();
        tg.HapticFeedback.notificationOccurred('success');
    }

    function spawnPest() {
        const pest = document.createElement('div');
        pest.className = 'pest';
        pest.innerText = Math.random() > 0.5 ? "üêõ" : "üê¶";
        pest.style.left = (Math.random() * 80 + 10) + "%";
        pest.style.top = (Math.random() * 60 + 20) + "%";
        document.body.appendChild(pest);

        pest.onclick = () => {
            pest.remove();
            tg.HapticFeedback.impactOccurred('heavy');
        };

        setTimeout(() => {
            if(pest.parentNode) {
                u.bal = Math.max(0, u.bal - 5);
                updateUI();
                pest.remove();
            }
        }, 5000);
    }

    function openRank() {
        document.getElementById('m-title').innerText = "REYTING";
        db.ref('users').orderByChild('bal').limitToLast(10).once('value', s => {
            let list = [];
            s.forEach(c => { list.push(c.val()); });
            list.reverse();
            let h = list.map((x, i) => `<div class="item-row"><span>${i+1}. ${x.name}</span> <b>${Math.floor(x.bal)} RC</b></div>`).join('');
            document.getElementById('m-body').innerHTML = h;
            document.getElementById('modal-overlay').style.display = 'flex';
        });
    }

    function save() { db.ref('users/' + uid).set(u); }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function goHome() { showMenu(); }
    function invite() { tg.openTelegramLink("https://t.me/share/url?url=https://t.me/RPlay_game_bot"); }

    init();
</script>
</body>
</html>