<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-Nature: Ultimate Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: 'Segoe UI', sans-serif; background: #ffffff; overflow: hidden; color: #333; }
        
        /* EKRANLAR */
        #lang-screen, #menu-screen, #game-screen { position: fixed; inset: 0; background: #ffffff; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        
        /* UI */
        .play-btn { width: 130px; height: 130px; background: #ffcc00; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: 900; color: #fff; border: 8px solid #f9f9f9; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 90%; max-width: 400px; }
        .btn { background: #007aff; color: #fff; padding: 15px; border-radius: 15px; border: none; font-weight: 600; cursor: pointer; text-align: center; }

        /* TOP STATS */
        .top-ui { position: absolute; top: 15px; width: 100%; padding: 0 15px; z-index: 1100; display: flex; flex-direction: column; gap: 5px; }
        .stats-row { display: flex; justify-content: space-between; align-items: center; }
        .pill { background: #f8f9fa; padding: 6px 12px; border-radius: 20px; border: 1.5px solid #eee; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .energy-bar { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
        #energy-fill { height: 100%; background: #ffcc00; width: 100%; transition: 0.3s; }

        /* GARDEN */
        #garden { width: 100%; height: 100%; position: relative; background: #ffffff; }
        .plant { position: absolute; transform: translate(-50%, -100%); font-size: 45px; text-align: center; cursor: pointer; }
        .water-icon { font-size: 20px; position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: #007aff; border-radius: 50%; padding: 4px; color: white; animation: pulse 1s infinite; }
        .profit-tag { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 2px 8px; border-radius: 8px; font-size: 12px; }

        /* NAV */
        .nav-bar { position: absolute; bottom: 20px; display: flex; gap: 15px; z-index: 1100; }
        .icon-btn { width: 60px; height: 60px; border-radius: 20px; background: #f8f9fa; border: 1.5px solid #eee; font-size: 28px; display: flex; align-items: center; justify-content: center; }

        /* MODAL */
        #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal { background: #fff; width: 90%; border-radius: 25px; padding: 20px; max-height: 80vh; overflow-y: auto; }
        .shop-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }

        @keyframes pulse { 0% { scale: 1; } 50% { scale: 1.2; } 100% { scale: 1; } }
    </style>
</head>
<body>

    <div id="lang-screen" style="display: flex;">
        <h2 style="margin-bottom: 20px;">Choose Language</h2>
        <div id="lang-list" class="grid-container"></div>
    </div>

    <div id="menu-screen">
        <h1 style="color: #28a745; margin-bottom: 20px; font-weight: 900;">R-NATURE</h1>
        <div class="play-btn" onclick="startGame()">PLAY</div>
        <div class="grid-container">
            <button class="btn" onclick="openShop()" id="t-shop">üõí Shop</button>
            <button class="btn" onclick="openRank()" id="t-rank">üèÜ Rank</button>
            <button class="btn" onclick="openInv()" id="t-bag">üéí Bag</button>
            <button class="btn" onclick="invite()" id="t-invite">üë• Invite</button>
        </div>
    </div>

    <div id="game-screen">
        <div class="top-ui">
            <div class="stats-row">
                <div class="pill" onclick="goHome()">üè†</div>
                <div class="pill">üí∞ <span id="bal-txt">50</span></div>
                <div class="pill">‚≠ê Lvl <span id="lvl-txt">1</span></div>
            </div>
            <div class="energy-bar"><div id="energy-fill"></div></div>
            <div style="font-size: 10px; display: flex; justify-content: space-between;">
                <span>‚ö° Energy</span> <span id="nrg-txt">100/100</span>
            </div>
        </div>
        <div id="garden"></div>
        <div class="nav-bar">
            <button class="icon-btn" onclick="openInv()">üéí</button>
            <button class="icon-btn" onclick="openShop()" style="color:#007aff">üõí</button>
            <button class="icon-btn" onclick="openDaily()">üéÅ</button>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal">
            <h2 id="m-title" style="text-align: center; margin-bottom: 15px;"></h2>
            <div id="m-body"></div>
            <button onclick="closeModal()" id="t-close" style="width:100%; margin-top:15px; padding:15px; border-radius:15px; background:#ff3b30; color:#fff; border:none; font-weight:bold;">Close</button>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBK57eb0Wr_x2x-PFC-a5PAzqBzdKMeic",
        authDomain: "r-nature.firebaseapp.com",
        projectId: "r-nature",
        databaseURL: "https://r-nature-default-rtdb.firebaseio.com/",
        storageBucket: "r-nature.firebasestorage.app",
        messagingSenderId: "504684708516",
        appId: "1:504684708516:web:c4545ae8a8b94bc0391c31"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tg = window.Telegram.WebApp;
    const uid = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "local_test";

    let u = { bal: 50, nrg: 100, lvl: 1, xp: 0, lang: null, inv: {"Rose": 1}, planted: [], lastDaily: 0, streak: 0, lastNrg: Date.now(), name: tg.initDataUnsafe.user?.first_name || "Gamer" };
    let selSeed = null;

    const dict = {
        uz: {shop:"Do'kon", rank:"Reyting", bag:"Sandiq", invite:"Taklif", close:"Yopish", sow:"Ekish", buy:"Sotib olish"},
        en: {shop:"Shop", rank:"Rank", bag:"Bag", invite:"Invite", close:"Close", sow:"Sow", buy:"Buy"},
        ru: {shop:"–ú–∞–≥–∞–∑–∏–Ω", rank:"–†–µ–π—Ç–∏–Ω–≥", bag:"–°—É–º–∫–∞", invite:"–î—Ä—É–∑—å—è", close:"–ó–∞–∫—Ä—ã—Ç—å", sow:"–ü–æ—Å–µ—è—Ç—å", buy:"–ö—É–ø–∏—Ç—å"},
        tr: {shop:"Maƒüaza", rank:"Sƒ±ralama", bag:"√áanta", invite:"Davet", close:"Kapat", sow:"Ek", buy:"Satƒ±n al"},
        tj: {shop:"–î”Ø–∫–æ–Ω", rank:"–†–µ–π—Ç–∏–Ω–≥", bag:"–•–∞–ª—Ç–∞", invite:"–î–∞—ä–≤–∞—Ç", close:"–ü”Ø—à–∏–¥–∞–Ω", sow:"–ö–æ—à—Ç–∞–Ω", buy:"–•–∞—Ä–∏–¥–∞–Ω"},
        de: {shop:"Laden", rank:"Rang", bag:"Tasche", invite:"Einladen", close:"Schlie√üen", sow:"S√§en", buy:"Kaufen"},
        fr: {shop:"Boutique", rank:"Rang", bag:"Sac", invite:"Inviter", close:"Fermer", sow:"Semer", buy:"Acheter"},
        es: {shop:"Tienda", rank:"Rango", bag:"Bolsa", invite:"Invitar", close:"Cerrar", sow:"Sembrar", buy:"Comprar"},
        pt: {shop:"Loja", rank:"Ranking", bag:"Bolsa", invite:"Convidar", close:"Fechar", sow:"Semear", buy:"Comprar"},
        it: {shop:"Negozio", rank:"Classifica", bag:"Borsa", invite:"Invita", close:"Chiudi", sow:"Seminare", buy:"Comprare"}
    };

    const items = [
        { id: "Rose", n: "Rose", p: 10, i: "üåπ", t: 300, xp: 10 }, // 5 min
        { id: "Cactus", n: "Cactus", p: 25, i: "üåµ", t: 420, xp: 25 }, // 7 min
        { id: "Sunf", n: "Sunflower", p: 80, i: "üåª", t: 600, xp: 50 }, // 10 min
        { id: "Magic", n: "Magic Tree", p: 100000, i: "‚ú®üå≥", t: 3600, xp: 1000 }
    ];

    function init() {
        const lList = document.getElementById('lang-list');
        const flags = { uz:"üá∫üáø Uzb", en:"üá∫üá∏ Eng", ru:"üá∑üá∫ Rus", tr:"üáπüá∑ Tur", tj:"üáπüáØ Toj", de:"üá©üá™ Ger", fr:"üá´üá∑ Fra", es:"üá™üá∏ Esp", pt:"üáµüáπ Por", it:"üáÆüáπ Ita" };
        Object.keys(flags).forEach(k => {
            const b = document.createElement('button'); b.className = 'btn';
            b.innerText = flags[k]; b.onclick = () => { u.lang = k; save(); showMenu(); };
            lList.appendChild(b);
        });
        db.ref('users/'+uid).once('value', s => { if(s.exists()){ u = s.val(); if(u.lang) showMenu(); }});
        setInterval(tick, 1000);
    }

    function tick() {
        if(u.nrg < 100) {
            const elap = (Date.now() - u.lastNrg) / 60000;
            if(elap >= 1) { u.nrg = Math.min(100, u.nrg + Math.floor(elap)); u.lastNrg = Date.now(); updateUI(); }
        }
        if(document.getElementById('game-screen').style.display === 'flex') renderGarden();
    }

    function showMenu() {
        document.getElementById('lang-screen').style.display = 'none';
        document.getElementById('menu-screen').style.display = 'flex';
        document.getElementById('game-screen').style.display = 'none';
        const t = dict[u.lang];
        document.getElementById('t-shop').innerText = "üõí "+t.shop;
        document.getElementById('t-rank').innerText = "üèÜ "+t.rank;
        document.getElementById('t-bag').innerText = "üéí "+t.bag;
        document.getElementById('t-invite').innerText = "üë• "+t.invite;
        document.getElementById('t-close').innerText = t.close;
        updateUI();
    }

    function startGame() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        renderGarden();
    }

    function updateUI() {
        document.getElementById('bal-txt').innerText = u.bal.toFixed(1);
        document.getElementById('lvl-txt').innerText = u.lvl;
        document.getElementById('nrg-txt').innerText = u.nrg + "/100";
        document.getElementById('energy-fill').style.width = u.nrg + "%";
    }

    function openShop() {
        document.getElementById('m-title').innerText = dict[u.lang].shop;
        let h = "";
        items.forEach(it => { h += `<div class="shop-row"><span>${it.i} ${it.n} (${it.p} RC)</span><button class="btn" style="padding:8px" onclick="buy('${it.id}')">${dict[u.lang].buy}</button></div>`; });
        document.getElementById('m-body').innerHTML = h;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function openInv() {
        document.getElementById('m-title').innerText = dict[u.lang].bag;
        let h = "";
        for(let k in u.inv) {
            if(u.inv[k] > 0) {
                const it = items.find(x => x.id === k);
                h += `<div class="shop-row"><span>${it.i} ${it.n} (x${u.inv[k]})</span><button class="btn" style="background:#28a745; padding:8px" onclick="select('${k}')">${dict[u.lang].sow}</button></div>`;
            }
        }
        document.getElementById('m-body').innerHTML = h || "...";
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.buy = (id) => {
        const it = items.find(x => x.id === id);
        if(u.bal >= it.p) { u.bal -= it.p; u.inv[id] = (u.inv[id] || 0) + 1; save(); updateUI(); }
        else tg.showAlert("No RC!");
    };

    window.select = (id) => { selSeed = id; closeModal(); if(document.getElementById('game-screen').style.display !== 'flex') startGame(); };

    document.getElementById('garden').onclick = (e) => {
        if(!selSeed || u.inv[selSeed] <= 0) return;
        if(u.nrg < 10) { tg.showAlert("‚ö° Low Energy!"); return; }
        const it = items.find(x => x.id === selSeed);
        u.planted.push({ x: e.clientX, y: e.clientY, id: it.id, t: Date.now(), watered: false });
        u.inv[selSeed]--; u.nrg -= 10; u.xp += it.xp; checkLvl(); save(); updateUI(); renderGarden();
    };

    function renderGarden() {
        const g = document.getElementById('garden'); g.innerHTML = '';
        u.planted.forEach((p, idx) => {
            const it = items.find(x => x.id === p.id);
            const age = (Date.now() - p.t) / 1000;
            const div = document.createElement('div'); div.className = 'plant';
            div.style.left = p.x + 'px'; div.style.top = p.y + 'px';
            if(age >= it.t) {
                div.innerHTML = `<div class="profit-tag">+${it.p*2} RC</div>${it.i}`;
                div.onclick = (e) => { e.stopPropagation(); collect(idx); };
            } else {
                if(!p.watered) {
                    div.innerHTML = `<div class="water-icon">üö∞</div>ü´ò`;
                    div.onclick = (e) => { e.stopPropagation(); water(idx); };
                } else div.innerText = age > it.t/2 ? "üå±" : "ü´ò";
            }
            g.appendChild(div);
        });
    }

    function water(idx) {
        if(u.nrg < 5) return;
        u.planted[idx].watered = true; u.nrg -= 5; save(); updateUI(); renderGarden();
    }

    function collect(idx) {
        const p = u.planted[idx]; u.bal += items.find(x => x.id === p.id).p * 2;
        u.planted.splice(idx, 1); save(); updateUI(); renderGarden();
    }

    function checkLvl() { if(u.xp >= u.lvl * 100) { u.lvl++; u.xp = 0; } }
    function save() { db.ref('users/'+uid).set(u); }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function goHome() { showMenu(); }
    function openDaily() {
        const can = (Date.now() - u.lastDaily) > 86400000;
        document.getElementById('m-title').innerText = "Gift";
        document.getElementById('m-body').innerHTML = `<button class="btn" ${can?'':'disabled'} onclick="claimDaily()">Claim Daily Bonus</button>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    window.claimDaily = () => { u.bal += 10; u.lastDaily = Date.now(); save(); closeModal(); updateUI(); };
    function openRank() {
        db.ref('users').orderByChild('bal').limitToLast(10).once('value', s => {
            let l = []; s.forEach(c => l.push(c.val()));
            document.getElementById('m-body').innerHTML = l.reverse().map((x,i)=>`<div>${i+1}. ${x.name} - ${x.bal.toFixed(0)}</div>`).join('');
            document.getElementById('modal-overlay').style.display = 'flex';
        });
    }
    function invite() { tg.openTelegramLink("https://t.me/share/url?url=https://t.me/RPlay_game_bot"); }

    init();
</script>
</body>
</html>