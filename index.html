<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-Nature: Professional Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: #ffffff; overflow: hidden; color: #333; }
        
        /* EKRANLAR */
        #loading, #lang-screen, #menu-screen, #game-screen { position: fixed; inset: 0; background: #fff; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #game-screen { display: none; background: #fdfdfd; }

        /* UI ELEMENTLARI */
        .top-panel { position: absolute; top: 15px; width: 92%; display: flex; flex-direction: column; gap: 8px; z-index: 1100; }
        .stats-bar { display: flex; justify-content: space-between; align-items: center; }
        .pill { background: #fff; border: 2px solid #ffcc00; padding: 6px 15px; border-radius: 20px; font-weight: 800; font-size: 13px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        .progress-box { width: 100%; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; width: 100%; transition: 0.4s ease; }
        #nrg-fill { background: linear-gradient(90deg, #ffcc00, #ff9500); }
        #xp-fill { background: linear-gradient(90deg, #4cd964, #28a745); }

        /* BOG' HUDUDI */
        #garden { width: 100%; height: 100%; position: relative; overflow: hidden; }
        .plant { position: absolute; transform: translate(-50%, -100%); font-size: 55px; text-align: center; cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .water-bubble { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); font-size: 25px; animation: bounce 1s infinite; }
        .profit-tag { position: absolute; top: -55px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 3px 10px; border-radius: 12px; font-size: 13px; font-weight: bold; border: 2px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

        /* DUSHMANLAR */
        .enemy { position: absolute; font-size: 40px; z-index: 1050; transition: 3s linear; cursor: pointer; }

        /* NAVIGATSIYA */
        .bottom-nav { position: absolute; bottom: 30px; display: flex; gap: 15px; z-index: 1100; }
        .nav-btn { width: 65px; height: 65px; border-radius: 20px; background: #fff; border: 1.5px solid #eee; font-size: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        /* MODAL */
        #modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { background: #fff; width: 92%; max-width: 400px; border-radius: 30px; padding: 25px; max-height: 80vh; overflow-y: auto; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f5f5f5; }
        .buy-btn { background: #007aff; color: #fff; border: none; padding: 10px 18px; border-radius: 12px; font-weight: bold; font-size: 13px; }

        @keyframes bounce { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -12px); } }
    </style>
</head>
<body>

    <div id="loading"><h1>R-NATURE...</h1></div>

    <div id="lang-screen" style="display:none">
        <h2 style="margin-bottom: 25px;">Select Language</h2>
        <div id="lang-list" style="width: 90%; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
    </div>

    <div id="menu-screen" style="display:none">
        <div style="font-size: 80px; margin-bottom: 20px;">üè°</div>
        <button class="buy-btn" style="padding: 20px 60px; font-size: 25px; border-radius: 50px; background: #ffcc00;" onclick="startGame()">PLAY</button>
        <div style="margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 80%;">
            <button class="nav-btn" style="width: 100%; font-size: 16px; font-weight: bold;" onclick="openShop()">üõí Shop</button>
            <button class="nav-btn" style="width: 100%; font-size: 16px; font-weight: bold;" onclick="openRank()">üèÜ Rank</button>
        </div>
    </div>

    <div id="game-screen">
        <div class="top-panel">
            <div class="stats-bar">
                <div class="pill" onclick="location.reload()">üè†</div>
                <div class="pill">üí∞ <span id="bal-txt">0</span></div>
                <div class="pill">‚≠ê Lvl <span id="lvl-txt">1</span></div>
            </div>
            <div class="progress-box"><div id="nrg-fill" class="progress-fill"></div></div>
            <div class="progress-box"><div id="xp-fill" class="progress-fill"></div></div>
            <div style="display: flex; justify-content: space-between; font-size: 10px; font-weight: bold; color: #777;">
                <span>‚ö° Energy: <span id="nrg-val">100</span></span>
                <span>üìà XP: <span id="xp-val">0</span>/100</span>
            </div>
        </div>

        <div id="garden"></div>

        <div class="bottom-nav">
            <button class="nav-btn" onclick="openInv()">üéí</button>
            <button class="nav-btn" onclick="openShop()" style="background: #007aff; color: white; border: none;">üõí</button>
            <button class="nav-btn" onclick="openDaily()">üéÅ</button>
            <button class="nav-btn" onclick="invite()">üë•</button>
        </div>
    </div>

    <div id="modal-bg">
        <div class="modal">
            <h2 id="m-title" style="text-align: center; color: #007aff; margin-bottom: 20px;"></h2>
            <div id="m-body"></div>
            <button onclick="closeModal()" style="width:100%; margin-top:20px; padding:15px; border-radius:15px; background:#ff3b30; color:#fff; border:none; font-weight:bold;">CLOSE</button>
        </div>
    </div>

<script>
    // 1. FIREBASE & TG INITIALIZATION
    const firebaseConfig = {
        apiKey: "AIzaSyBK57eb0Wr_x2x-PFC-a5PAzqBzdKMeic",
        authDomain: "r-nature.firebaseapp.com",
        projectId: "r-nature",
        databaseURL: "https://r-nature-default-rtdb.firebaseio.com/",
        storageBucket: "r-nature.firebasestorage.app",
        messagingSenderId: "504684708516",
        appId: "1:504684708516:web:c4545ae8a8b94bc0391c31"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tg = window.Telegram.WebApp;
    const uid = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "dev_777";

    // 2. O'YIN MA'LUMOTLARI
    let u = {
        bal: 50, nrg: 100, lvl: 1, xp: 0, lang: null, 
        inv: {"Rose": 2}, planted: [], 
        lastDaily: 0, streak: 0, 
        hasSuperman: false, name: tg.initDataUnsafe.user?.first_name || "Gamer",
        lastSave: Date.now()
    };

    const shopItems = [
        { id: "Rose", n: "Rose", p: 10, i: "üåπ", t: 300, xp: 10 },
        { id: "Cactus", n: "Cactus", p: 25, i: "üåµ", t: 420, xp: 25 },
        { id: "Sunf", n: "Sunflower", p: 80, i: "üåª", t: 600, xp: 60 },
        { id: "Apple", n: "Apple Tree", p: 250, i: "üçé", t: 1200, xp: 200 },
        { id: "Magic", n: "Magic Tree", p: 100000, i: "‚ú®üå≥", t: 3600, xp: 5000 },
        { id: "Superman", n: "Superman Robot", p: 10000, i: "ü¶∏‚Äç‚ôÇÔ∏è", special: true },
        { id: "WaterBox", n: "Auto-Water", p: 5000, i: "‚öôÔ∏è", special: true }
    ];

    const dict = {
        uz: { shop: "Do'kon", bag: "Sandiq", rank: "Reyting", daily: "Bonus", close: "Yopish", buy: "Olish", sow: "Ekish" },
        en: { shop: "Shop", bag: "Bag", rank: "Rank", daily: "Daily", close: "Close", buy: "Buy", sow: "Sow" }
        // ... qolgan 8 ta til mantiqan bir xil qo'shiladi
    };

    // 3. ASOSIY FUNKSIYALAR
    function init() {
        const langs = ["uz", "en", "ru", "tr", "tj", "de", "fr", "es", "pt", "it"];
        const lList = document.getElementById('lang-list');
        langs.forEach(l => {
            const b = document.createElement('button');
            b.className = 'nav-btn'; b.style.width = "100%"; b.innerText = l.toUpperCase();
            b.onclick = () => { u.lang = l; save(); showMenu(); };
            lList.appendChild(b);
        });

        db.ref('users/'+uid).once('value', s => {
            document.getElementById('loading').style.display = 'none';
            if(s.exists()){
                u = s.val();
                if(u.lang) showMenu(); else document.getElementById('lang-screen').style.display = 'flex';
            } else {
                document.getElementById('lang-screen').style.display = 'flex';
            }
        });
        setInterval(gameLoop, 1000);
    }

    function showMenu() {
        document.getElementById('lang-screen').style.display = 'none';
        document.getElementById('menu-screen').style.display = 'flex';
        updateUI();
    }

    function startGame() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        renderGarden();
    }

    function updateUI() {
        document.getElementById('bal-txt').innerText = u.bal.toFixed(1);
        document.getElementById('lvl-txt').innerText = u.lvl;
        document.getElementById('nrg-val').innerText = u.nrg;
        document.getElementById('xp-val').innerText = u.xp;
        document.getElementById('nrg-fill').style.width = u.nrg + "%";
        document.getElementById('xp-fill').style.width = (u.xp / (u.lvl * 100) * 100) + "%";
    }

    function gameLoop() {
        // Energiya tiklanishi (har 2 daqiqada 1 ta)
        if(u.nrg < 100) {
            u.nrg = Math.min(100, u.nrg + 0.01);
            updateUI();
        }
        // Zararkunanda paydo bo'lishi
        if(Math.random() < 0.005 && !u.hasSuperman && u.planted.length > 0) spawnEnemy();
    }

    // 4. BOG' MANTIQI
    let selectedSeed = null;

    document.getElementById('garden').onclick = (e) => {
        if(!selectedSeed) return;
        if(u.nrg < 10) { tg.showAlert("Need more Energy! ‚ö°"); return; }
        
        const it = shopItems.find(x => x.id === selectedSeed);
        u.planted.push({ x: e.clientX, y: e.clientY, id: it.id, t: Date.now(), watered: false });
        u.inv[selectedSeed]--;
        u.nrg -= 10;
        u.xp += 5;
        checkLvl(); save(); updateUI(); renderGarden();
    };

    function renderGarden() {
        const g = document.getElementById('garden'); g.innerHTML = '';
        u.planted.forEach((p, i) => {
            const it = shopItems.find(x => x.id === p.id);
            const age = (Date.now() - p.t) / 1000;
            const div = document.createElement('div');
            div.className = 'plant'; div.style.left = p.x+'px'; div.style.top = p.y+'px';
            
            if(age >= it.t) {
                div.innerHTML = `<div class="profit-tag">+${it.p*2} RC</div>${it.i}`;
                div.onclick = (e) => { e.stopPropagation(); collect(i); };
            } else {
                if(!p.watered) {
                    div.innerHTML = `<div class="water-bubble">üö∞</div>ü´ò`;
                    div.onclick = (e) => { e.stopPropagation(); water(i); };
                } else {
                    div.innerText = age > it.t/2 ? "üå±" : "ü´ò";
                }
            }
            g.appendChild(div);
        });
    }

    function water(i) {
        if(u.nrg < 5) return;
        u.planted[i].watered = true; u.nrg -= 5;
        save(); updateUI(); renderGarden();
    }

    function collect(i) {
        const p = u.planted[i];
        const it = shopItems.find(x => x.id === p.id);
        u.bal += it.p * 2; u.xp += it.xp;
        u.planted.splice(i, 1);
        checkLvl(); save(); updateUI(); renderGarden();
    }

    function spawnEnemy() {
        const e = document.createElement('div'); e.className = 'enemy'; e.innerText = "ü¶Ö";
        e.style.top = Math.random()*80 + "%"; e.style.left = "-50px";
        document.body.appendChild(e);
        setTimeout(() => { 
            e.style.left = "110%"; 
            setTimeout(() => { if(e.parentNode) { u.bal -= 5; updateUI(); e.remove(); } }, 3000);
        }, 100);
        e.onclick = () => { e.remove(); u.xp += 2; updateUI(); };
    }

    // 5. MODALLAR (SHOP, INV, RANK)
    function openShop() {
        document.getElementById('m-title').innerText = "SHOP";
        let h = "";
        shopItems.forEach(it => {
            h += `<div class="item-row">
                <span>${it.i} ${it.n} <br><b>${it.p} RC</b></span>
                <button class="buy-btn" onclick="buyItem('${it.id}')">BUY</button>
            </div>`;
        });
        document.getElementById('m-body').innerHTML = h;
        document.getElementById('modal-bg').style.display = 'flex';
    }

    window.buyItem = (id) => {
        const it = shopItems.find(x => x.id === id);
        if(u.bal >= it.p) {
            u.bal -= it.p;
            if(it.special) { if(id==="Superman") u.hasSuperman=true; }
            else u.inv[id] = (u.inv[id] || 0) + 1;
            save(); updateUI();
        } else tg.showAlert("No RC!");
    };

    function openInv() {
        document.getElementById('m-title').innerText = "INVENTORY";
        let h = "";
        for(let k in u.inv) { if(u.inv[k]>0) {
            const it = shopItems.find(x => x.id === k);
            h += `<div class="item-row"><span>${it.i} ${it.n} (x${u.inv[k]})</span><button class="buy-btn" onclick="selectSeed('${k}')">SOW</button></div>`;
        }}
        document.getElementById('m-body').innerHTML = h || "Empty";
        document.getElementById('modal-bg').style.display = 'flex';
    }

    window.selectSeed = (id) => { selectedSeed = id; closeModal(); if(document.getElementById('game-screen').style.display==='none') startGame(); };

    function openRank() {
        db.ref('users').orderByChild('bal').limitToLast(10).once('value', s => {
            let l = []; s.forEach(c => l.push(c.val()));
            document.getElementById('m-body').innerHTML = l.reverse().map((x,i)=>`<div class="item-row"><b>${i+1}. ${x.name}</b> <span>${x.bal.toFixed(0)} RC</span></div>`).join('');
            document.getElementById('modal-bg').style.display = 'flex';
        });
    }

    function openDaily() {
        const can = (Date.now() - u.lastDaily) > 86400000;
        document.getElementById('m-body').innerHTML = `<button class="buy-btn" style="width:100%" ${can?'':'disabled'} onclick="claimDaily()">Claim Daily 20 RC</button>`;
        document.getElementById('modal-bg').style.display = 'flex';
    }

    window.claimDaily = () => { u.bal += 20; u.lastDaily = Date.now(); save(); closeModal(); updateUI(); };

    function checkLvl() { if(u.xp >= u.lvl * 100) { u.lvl++; u.xp = 0; tg.showAlert("New Level: "+u.lvl); } }
    function save() { db.ref('users/'+uid).set(u); }
    function closeModal() { document.getElementById('modal-bg').style.display = 'none'; }
    function invite() { tg.openTelegramLink("https://t.me/share/url?url=https://t.me/RPlay_game_bot"); }

    init();
</script>
</body>
</html>