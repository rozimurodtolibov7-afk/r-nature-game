<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-Nature: Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: 'Arial', sans-serif; background: #fff; overflow: hidden; }
        
        /* UI Elementlari */
        .header { position: absolute; top: 10px; width: 100%; padding: 0 15px; z-index: 10; display: flex; flex-direction: column; gap: 5px; }
        .stats-row { display: flex; justify-content: space-between; }
        .stat-pill { background: #f0f0f0; padding: 5px 15px; border-radius: 20px; font-weight: bold; border: 1px solid #ddd; display: flex; align-items: center; gap: 5px; }
        .energy-container { width: 100%; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; }
        #energy-fill { height: 100%; background: #ffcc00; width: 100%; transition: 0.3s; }

        /* O'yin Maydoni */
        #garden { width: 100vw; height: 100vh; position: relative; background: #fff; }
        .plant { position: absolute; transform: translate(-50%, -100%); font-size: 50px; text-align: center; }
        .water-bubble { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); background: #007aff; color: white; padding: 2px 10px; border-radius: 10px; font-size: 14px; animation: bounce 1s infinite; }
        .harvest-tag { position: absolute; top: -55px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 2px 10px; border-radius: 10px; font-size: 14px; }
        .pest { position: absolute; font-size: 40px; z-index: 5; cursor: pointer; transition: 0.5s; }

        /* Shop va Modallar */
        #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; }
        .modal { background: #fff; width: 90%; border-radius: 25px; padding: 20px; position: relative; max-height: 70vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; color: #ff3b30; font-weight: bold; border: none; background: none; }
        .item-card { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .btn-buy { background: #007aff; color: white; padding: 8px 15px; border-radius: 12px; border: none; font-weight: bold; }

        /* Navigatsiya */
        .bottom-nav { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 20px; }
        .nav-icon { width: 60px; height: 60px; background: #f8f8f8; border-radius: 20px; border: 1px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        @keyframes bounce { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -10px); } }
    </style>
</head>
<body>

    <div class="header">
        <div class="stats-row">
            <div class="stat-pill">üí∞ <span id="balance">50</span></div>
            <div class="stat-pill">‚ö° <span id="energy-text">100/100</span></div>
        </div>
        <div class="energy-container"><div id="energy-fill"></div></div>
    </div>

    <div id="garden"></div>

    <div class="bottom-nav">
        <div class="nav-icon" onclick="openInventory()">üéí</div>
        <div class="nav-icon" onclick="openShop()">üõí</div>
        <div class="nav-icon" onclick="openRank()">üèÜ</div>
    </div>

    <div id="modal-overlay">
        <div class="modal">
            <button class="close-btn" onclick="closeModal()">‚úï</button>
            <h2 id="modal-title" style="text-align:center; margin-bottom:20px;"></h2>
            <div id="modal-body"></div>
        </div>
    </div>

<script>
    // Firebase sozlamalari (Yuborgan rasmdagi loyihaga moslangan)
    const firebaseConfig = { databaseURL: "https://r-nature-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tg = window.Telegram.WebApp;
    const uid = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "test_user";

    let userData = {
        bal: 50, nrg: 100, lastDaily: 0, inv: {"Rose": 1}, planted: [],
        lastNrgUpdate: Date.now(), name: tg.initDataUnsafe.user?.first_name || "Fermer"
    };

    const shopItems = [
        { id: "Rose", name: "Atirgul", price: 10, img: "üåπ", time: 300 },
        { id: "Cactus", name: "Kaktus", price: 25, img: "üåµ", time: 420 },
        { id: "Sunf", name: "Kungaboqar", price: 60, img: "üåª", time: 600 },
        { id: "Magic", name: "Sehrli Daraxt", price: 5000, img: "üå≥", time: 3600 }
    ];

    function init() {
        db.ref('users/' + uid).once('value', s => {
            if (s.exists()) userData = s.val();
            checkDailyReward();
            updateUI();
            setInterval(tick, 1000);
            renderGarden();
        });
    }

    function checkDailyReward() {
        const now = Date.now();
        if (now - userData.lastDaily > 86400000) {
            userData.bal += 20;
            userData.lastDaily = now;
            save();
            tg.showAlert("Xush kelibsiz! Kunlik bonus: 20 RC");
        }
    }

    function tick() {
        // Energiya tiklanishi (1 min = +1 ‚ö°)
        if (userData.nrg < 100 && Date.now() - userData.lastNrgUpdate > 60000) {
            userData.nrg++;
            userData.lastNrgUpdate = Date.now();
            updateUI();
        }
        
        // Zararkunanda chiqishi (10% imkoniyat)
        if (Math.random() < 0.01 && userData.planted.length > 0) spawnPest();
        
        renderGarden();
    }

    function updateUI() {
        document.getElementById('balance').innerText = userData.bal;
        document.getElementById('energy-text').innerText = userData.nrg + "/100";
        document.getElementById('energy-fill').style.width = userData.nrg + "%";
    }

    function openShop() {
        const modal = document.getElementById('modal-body');
        document.getElementById('modal-title').innerText = "Do'kon";
        modal.innerHTML = shopItems.map(it => `
            <div class="item-card">
                <span>${it.img} ${it.name} (${it.price} RC)</span>
                <button class="btn-buy" onclick="buyItem('${it.id}')">Sotib olish</button>
            </div>
        `).join('');
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.buyItem = (id) => {
        const it = shopItems.find(x => x.id === id);
        if (userData.bal >= it.price) {
            userData.bal -= it.price;
            userData.inv[id] = (userData.inv[id] || 0) + 1;
            save(); updateUI();
        } else tg.showAlert("Mablag' yetarli emas!");
    };

    function openInventory() {
        const modal = document.getElementById('modal-body');
        document.getElementById('modal-title').innerText = "Sandiq";
        let content = "";
        for(let key in userData.inv) {
            if(userData.inv[key] > 0) {
                content += `<div class="item-card"><span>${key} (x${userData.inv[key]})</span><button class="btn-buy" onclick="sowSeed('${key}')">Ekish</button></div>`;
            }
        }
        modal.innerHTML = content || "Sandiq bo'sh";
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    window.sowSeed = (id) => {
        if (userData.nrg < 10) return tg.showAlert("Energiya kam!");
        const it = shopItems.find(x => x.id === id);
        const rect = document.getElementById('garden').getBoundingClientRect();
        userData.planted.push({
            id: id,
            x: Math.random() * (rect.width - 50) + 25,
            y: Math.random() * (rect.height - 150) + 75,
            time: Date.now(),
            watered: false
        });
        userData.inv[id]--;
        userData.nrg -= 10;
        save(); closeModal(); updateUI(); renderGarden();
    };

    function renderGarden() {
        const g = document.getElementById('garden');
        g.innerHTML = '';
        userData.planted.forEach((p, i) => {
            const it = shopItems.find(x => x.id === p.id);
            const age = (Date.now() - p.time) / 1000;
            const div = document.createElement('div');
            div.className = 'plant';
            div.style.left = p.x + 'px'; div.style.top = p.y + 'px';

            if (age >= it.time) {
                div.innerHTML = `<div class="harvest-tag">+${it.price * 2}</div>${it.img}`;
                div.onclick = () => collect(i);
            } else if (!p.watered) {
                div.innerHTML = `<div class="water-bubble">üö∞</div>üå±`;
                div.onclick = () => { if(userData.nrg>=5){p.watered=true; userData.nrg-=5; save(); updateUI();}};
            } else {
                div.innerText = age > it.time/2 ? "üåø" : "üå±";
            }
            g.appendChild(div);
        });
    }

    function collect(i) {
        const p = userData.planted[i];
        const it = shopItems.find(x => x.id === p.id);
        userData.bal += it.price * 2;
        userData.planted.splice(i, 1);
        save(); updateUI(); renderGarden();
    }

    function spawnPest() {
        const pest = document.createElement('div');
        pest.className = 'pest'; pest.innerText = "üêõ";
        pest.style.left = Math.random() * 80 + "%";
        pest.style.top = Math.random() * 80 + "%";
        document.body.appendChild(pest);
        pest.onclick = () => { pest.remove(); };
        setTimeout(() => { if(pest.parentNode){ userData.bal = Math.max(0, userData.bal - 5); updateUI(); pest.remove(); }}, 5000);
    }

    function save() { db.ref('users/' + uid).set(userData); }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function openRank() { tg.showAlert("Tez kunda..."); }

    init();
</script>
</body>
</html>