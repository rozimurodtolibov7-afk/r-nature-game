<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>X va 0 O'yini</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f; --surface: #12121a; --border: #2a2a45;
    --accent: #00f5ff; --accent2: #ff0066; --accent3: #7c3aed;
    --text: #e0e0ff; --text-dim: #6060a0;
    --x-color: #00f5ff; --o-color: #ff0066;
    --win-glow: #00ff88; --grid-line: #1e1e35;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'Exo 2',sans-serif; min-height:100vh; display:flex; align-items:center; justify-content:center; overflow:hidden; }
  body::before { content:''; position:fixed; inset:0; background: radial-gradient(ellipse at 20% 20%,rgba(0,245,255,0.05) 0%,transparent 50%), radial-gradient(ellipse at 80% 80%,rgba(255,0,102,0.05) 0%,transparent 50%); pointer-events:none; }
  .grid-bg { position:fixed; inset:0; background-image:linear-gradient(var(--grid-line) 1px,transparent 1px),linear-gradient(90deg,var(--grid-line) 1px,transparent 1px); background-size:40px 40px; opacity:0.4; pointer-events:none; }

  .screen { display:none; flex-direction:column; align-items:center; justify-content:center; width:100%; max-width:600px; padding:20px; animation:fadeIn 0.4s ease; }
  .screen.active { display:flex; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);} }

  .logo { font-family:'Orbitron',monospace; font-size:3rem; font-weight:900; letter-spacing:4px; margin-bottom:8px; }
  .logo .x { color:var(--x-color); text-shadow:0 0 20px var(--x-color); }
  .logo .sep { color:var(--text-dim); }
  .logo .o { color:var(--o-color); text-shadow:0 0 20px var(--o-color); }
  .tagline { font-size:0.75rem; letter-spacing:6px; color:var(--text-dim); text-transform:uppercase; margin-bottom:50px; }

  .lang-title { font-family:'Orbitron',monospace; font-size:0.7rem; letter-spacing:5px; color:var(--text-dim); text-transform:uppercase; margin-bottom:20px; }
  .lang-grid { display:flex; gap:16px; margin-bottom:50px; }
  .lang-btn { background:var(--surface); border:1px solid var(--border); color:var(--text); padding:16px 32px; font-family:'Orbitron',monospace; font-size:1rem; font-weight:700; letter-spacing:2px; cursor:pointer; transition:all 0.2s; position:relative; overflow:hidden; clip-path:polygon(8px 0%,100% 0%,calc(100% - 8px) 100%,0% 100%); }
  .lang-btn::before { content:''; position:absolute; inset:0; background:linear-gradient(135deg,var(--accent),var(--accent3)); opacity:0; transition:opacity 0.2s; }
  .lang-btn:hover::before { opacity:0.15; }
  .lang-btn:hover { border-color:var(--accent); color:var(--accent); box-shadow:0 0 20px rgba(0,245,255,0.2); transform:translateY(-2px); }
  .lang-btn .flag { display:block; font-size:1.5rem; margin-bottom:4px; }

  .mode-grid { display:flex; flex-direction:column; gap:14px; width:100%; max-width:380px; margin-bottom:30px; }
  .mode-btn { background:var(--surface); border:1px solid var(--border); color:var(--text); padding:20px 28px; font-family:'Exo 2',sans-serif; font-size:1rem; font-weight:600; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:16px; text-align:left; clip-path:polygon(12px 0%,100% 0%,calc(100% - 12px) 100%,0% 100%); }
  .mode-btn:hover { border-color:var(--accent); background:rgba(0,245,255,0.05); transform:translateX(4px); box-shadow:0 0 25px rgba(0,245,255,0.15); }
  .mode-btn .icon { font-size:2rem; }
  .mode-btn .desc { font-size:0.75rem; color:var(--text-dim); font-weight:300; margin-top:2px; }

  .size-grid { display:flex; gap:16px; margin-bottom:30px; }
  .size-btn { background:var(--surface); border:1px solid var(--border); color:var(--text); padding:16px 36px; font-family:'Orbitron',monospace; font-size:1.1rem; font-weight:700; cursor:pointer; transition:all 0.2s; clip-path:polygon(10px 0%,100% 0%,calc(100% - 10px) 100%,0% 100%); }
  .size-btn:hover { border-color:var(--accent2); color:var(--accent2); box-shadow:0 0 20px rgba(255,0,102,0.2); transform:translateY(-2px); }

  .back-btn { background:transparent; border:1px solid var(--border); color:var(--text-dim); padding:10px 24px; font-family:'Exo 2',sans-serif; font-size:0.85rem; cursor:pointer; transition:all 0.2s; letter-spacing:2px; }
  .back-btn:hover { border-color:var(--text-dim); color:var(--text); }

  .section-title { font-family:'Orbitron',monospace; font-size:0.65rem; letter-spacing:5px; color:var(--text-dim); text-transform:uppercase; margin-bottom:20px; margin-top:10px; }

  #gameScreen { padding:16px; }
  .game-header { display:flex; align-items:center; justify-content:space-between; width:100%; max-width:560px; margin-bottom:20px; }
  .game-title { font-family:'Orbitron',monospace; font-size:1rem; font-weight:700; letter-spacing:3px; color:var(--text-dim); }
  .score-board { display:flex; gap:8px; align-items:center; }
  .score-card { background:var(--surface); border:1px solid var(--border); padding:8px 16px; text-align:center; clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%); min-width:70px; }
  .score-card.x-card { border-color:rgba(0,245,255,0.3); }
  .score-card.o-card { border-color:rgba(255,0,102,0.3); }
  .score-card .label { font-size:0.6rem; letter-spacing:3px; color:var(--text-dim); text-transform:uppercase; display:block; }
  .score-card .val { font-family:'Orbitron',monospace; font-size:1.5rem; font-weight:900; }
  .score-card.x-card .val { color:var(--x-color); }
  .score-card.o-card .val { color:var(--o-color); }
  .score-sep { color:var(--text-dim); font-family:'Orbitron',monospace; font-size:1.2rem; }

  .turn-indicator { width:100%; max-width:560px; text-align:center; padding:10px; margin-bottom:16px; font-family:'Orbitron',monospace; font-size:0.8rem; letter-spacing:3px; border:1px solid var(--border); background:var(--surface); transition:all 0.3s; }
  .turn-indicator.x-turn { border-color:rgba(0,245,255,0.4); color:var(--x-color); }
  .turn-indicator.o-turn { border-color:rgba(255,0,102,0.4); color:var(--o-color); }

  .board { display:grid; gap:4px; background:var(--border); border:1px solid var(--border); padding:4px; }
  .board.size3 { grid-template-columns:repeat(3,1fr); }
  .board.size5 { grid-template-columns:repeat(5,1fr); }
  .cell { background:var(--surface); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.15s; position:relative; overflow:hidden; aspect-ratio:1; }
  .board.size3 .cell { width:110px; height:110px; font-size:3.5rem; }
  .board.size5 .cell { width:76px; height:76px; font-size:2.2rem; }
  .cell:hover:not(.taken) { background:rgba(255,255,255,0.04); }
  .cell.taken { cursor:not-allowed; }
  .cell .mark { font-family:'Orbitron',monospace; font-weight:900; animation:markAppear 0.2s cubic-bezier(0.34,1.56,0.64,1); }
  @keyframes markAppear { from{transform:scale(0) rotate(-10deg);opacity:0;}to{transform:scale(1) rotate(0deg);opacity:1;} }
  .cell .mark.x { color:var(--x-color); text-shadow:0 0 15px var(--x-color); }
  .cell .mark.o { color:var(--o-color); text-shadow:0 0 15px var(--o-color); }
  .cell.winning { background:rgba(0,255,136,0.08) !important; animation:winPulse 0.6s ease infinite alternate; }
  @keyframes winPulse { from{background:rgba(0,255,136,0.08);}to{background:rgba(0,255,136,0.18);} }
  .cell.winning .mark { text-shadow:0 0 20px var(--win-glow) !important; }

  .result-overlay { display:none; position:absolute; inset:0; background:rgba(10,10,15,0.92); backdrop-filter:blur(4px); align-items:center; justify-content:center; flex-direction:column; gap:16px; animation:fadeIn 0.3s ease; z-index:10; }
  .result-overlay.show { display:flex; }
  .result-text { font-family:'Orbitron',monospace; font-size:1.8rem; font-weight:900; letter-spacing:4px; text-align:center; }
  .result-text.x-win { color:var(--x-color); text-shadow:0 0 30px var(--x-color); }
  .result-text.o-win { color:var(--o-color); text-shadow:0 0 30px var(--o-color); }
  .result-text.draw { color:var(--text-dim); }
  .result-sub { font-size:0.75rem; letter-spacing:4px; color:var(--text-dim); text-transform:uppercase; }

  .game-actions { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
  .action-btn { padding:12px 28px; font-family:'Exo 2',sans-serif; font-size:0.85rem; font-weight:600; letter-spacing:2px; cursor:pointer; transition:all 0.2s; border:1px solid; text-transform:uppercase; clip-path:polygon(8px 0%,100% 0%,calc(100% - 8px) 100%,0% 100%); }
  .action-btn.primary { background:rgba(0,245,255,0.1); border-color:var(--accent); color:var(--accent); }
  .action-btn.primary:hover { background:rgba(0,245,255,0.2); box-shadow:0 0 20px rgba(0,245,255,0.3); }
  .action-btn.secondary { background:transparent; border-color:var(--border); color:var(--text-dim); }
  .action-btn.secondary:hover { border-color:var(--text-dim); color:var(--text); }

  .thinking { display:none; align-items:center; gap:8px; color:var(--text-dim); font-size:0.8rem; letter-spacing:3px; margin-top:8px; }
  .thinking.show { display:flex; }
  .thinking-dots span { animation:blink 1.2s infinite; display:inline-block; }
  .thinking-dots span:nth-child(2) { animation-delay:0.2s; }
  .thinking-dots span:nth-child(3) { animation-delay:0.4s; }
  @keyframes blink { 0%,80%,100%{opacity:0.2;}40%{opacity:1;} }

  #audioControls { position:fixed; top:16px; right:16px; display:flex; gap:8px; z-index:999; }
  #audioControls button { background:rgba(18,18,26,0.9); border:1px solid #2a2a45; color:#e0e0ff; width:40px; height:40px; font-size:1.1rem; cursor:pointer; border-radius:4px; transition:all 0.2s; }
  #audioControls button:hover { border-color:var(--accent); }

  @media (max-width:520px) {
    .logo { font-size:2rem; }
    .board.size3 .cell { width:90px; height:90px; font-size:2.8rem; }
    .board.size5 .cell { width:58px; height:58px; font-size:1.6rem; }
    .lang-btn { padding:12px 20px; font-size:0.9rem; }
  }
</style>
</head>
<body>
<div class="grid-bg"></div>

<div id="audioControls">
  <button id="soundBtn" onclick="toggleSound()">&#128266;</button>
  <button id="musicBtn" onclick="toggleMusic()">&#127925;</button>
</div>

<!-- LANG -->
<div class="screen active" id="langScreen">
  <div class="logo"><span class="x">X</span><span class="sep"> vs </span><span class="o">O</span></div>
  <div class="tagline" id="tagline">Choose your language</div>
  <div class="lang-title">Select Language / Tilni tanlang / &#1042;&#1099;&#1073;&#1077;&#1088;&#1080;&#1090;&#1077; &#1103;&#1079;&#1099;&#1082;</div>
  <div class="lang-grid">
    <button class="lang-btn" onclick="selectLang('uz')"><span class="flag">&#127482;&#127487;</span>UZ</button>
    <button class="lang-btn" onclick="selectLang('ru')"><span class="flag">&#127479;&#127482;</span>RU</button>
    <button class="lang-btn" onclick="selectLang('en')"><span class="flag">&#127468;&#127463;</span>EN</button>
  </div>
</div>

<!-- MODE -->
<div class="screen" id="modeScreen">
  <div class="logo"><span class="x">X</span><span class="sep"> vs </span><span class="o">O</span></div>
  <div class="section-title" id="modeTitle">Game Mode</div>
  <div class="mode-grid">
    <button class="mode-btn" onclick="selectMode('pvp')">
      <span class="icon">&#128101;</span>
      <div><div id="pvpLabel">2 Players</div><div class="desc" id="pvpDesc">Play against your friend</div></div>
    </button>
    <button class="mode-btn" onclick="selectMode('pve')">
      <span class="icon">&#129302;</span>
      <div><div id="pveLabel">vs Computer</div><div class="desc" id="pveDesc">Challenge the AI</div></div>
    </button>
  </div>
  <button class="back-btn" onclick="goBack('langScreen')" id="backBtn1">&#8592; Back</button>
</div>

<!-- SIZE -->
<div class="screen" id="sizeScreen">
  <div class="logo"><span class="x">X</span><span class="sep"> vs </span><span class="o">O</span></div>
  <div class="section-title" id="sizeTitle">Board Size</div>
  <div class="size-grid">
    <button class="size-btn" onclick="startGame(3)">3 &#215; 3</button>
    <button class="size-btn" onclick="startGame(5)">5 &#215; 5</button>
  </div>
  <button class="back-btn" onclick="goBack('modeScreen')" id="backBtn2">&#8592; Back</button>
</div>

<!-- GAME -->
<div class="screen" id="gameScreen">
  <div class="game-header">
    <div class="game-title" id="gameTitle">X vs O</div>
    <div class="score-board">
      <div class="score-card x-card">
        <span class="label" id="playerXLabel">PLAYER X</span>
        <span class="val" id="scoreX">0</span>
      </div>
      <div class="score-sep">&#8212;</div>
      <div class="score-card o-card">
        <span class="label" id="playerOLabel">PLAYER O</span>
        <span class="val" id="scoreO">0</span>
      </div>
    </div>
  </div>
  <div class="turn-indicator x-turn" id="turnIndicator">PLAYER X</div>
  <div style="position:relative;">
    <div class="board" id="board"></div>
    <div class="result-overlay" id="resultOverlay">
      <div class="result-text" id="resultText">X WINS!</div>
      <div class="result-sub" id="resultSub">Congratulations</div>
      <button class="action-btn primary" onclick="restartGame()" id="playAgainBtn">Play Again</button>
    </div>
  </div>
  <div class="thinking" id="thinking">
    <span id="thinkingText">AI thinking</span>
    <div class="thinking-dots"><span>&#9679;</span><span>&#9679;</span><span>&#9679;</span></div>
  </div>
  <div class="game-actions">
    <button class="action-btn primary" onclick="restartGame()" id="restartBtn">&#8635; Restart</button>
    <button class="action-btn secondary" onclick="goBack('modeScreen')" id="menuBtn">&#9776; Menu</button>
  </div>
</div>

<script>
var T = {
  uz: {
    tagline: "O'YIN TANLANG",
    modeTitle: "O'YIN REJIMI",
    pvpLabel: "2 O'yinchi",
    pvpDesc: "Do'stingiz bilan o'ynang",
    pveLabel: "Kompyuterga qarshi",
    pveDesc: "Sun'iy intellekt bilan o'ynang",
    sizeTitle: "MAYDON O'LCHAMI",
    back: "\u2190 Orqaga",
    playerX: "O'YINCHI X",
    playerO: "O'YINCHI O",
    computer: "KOMPYUTER",
    turnX: "X NAVBATI",
    turnO: "O NAVBATI",
    xWins: "X YUTDI!",
    oWins: "O YUTDI!",
    draw: "DURRANG!",
    congrats: "Tabriklaymiz",
    drawSub: "Hech kim yutmadi",
    playAgain: "\u21BA Qayta o'yna",
    restart: "\u21BA Yangilash",
    menu: "\u2630 Menyu",
    thinking: "AI o'ylayapti",
    gameTitle: "X va 0"
  },
  ru: {
    tagline: "\u0412\u042b\u0411\u041e\u0420 \u0418\u0413\u0420\u042b",
    modeTitle: "\u0420\u0415\u0416\u0418\u041c \u0418\u0413\u0420\u042b",
    pvpLabel: "2 \u0418\u0433\u0440\u043e\u043a\u0430",
    pvpDesc: "\u0418\u0433\u0440\u0430\u0439\u0442\u0435 \u0441 \u0434\u0440\u0443\u0433\u043e\u043c",
    pveLabel: "\u041f\u0440\u043e\u0442\u0438\u0432 \u043a\u043e\u043c\u043f\u044c\u044e\u0442\u0435\u0440\u0430",
    pveDesc: "\u0421\u0440\u0430\u0437\u0438\u0442\u0435\u0441\u044c \u0441 \u0418\u0418",
    sizeTitle: "\u0420\u0410\u0417\u041c\u0415\u0420 \u041f\u041e\u041b\u042f",
    back: "\u2190 \u041d\u0430\u0437\u0430\u0434",
    playerX: "\u0418\u0413\u0420\u041e\u041a X",
    playerO: "\u0418\u0413\u0420\u041e\u041a O",
    computer: "\u041a\u041e\u041c\u041f\u042c\u042e\u0422\u0415\u0420",
    turnX: "\u0425\u041e\u0414 X",
    turnO: "\u0425\u041e\u0414 O",
    xWins: "X \u041f\u041e\u0411\u0415\u0414\u0418\u041b!",
    oWins: "O \u041f\u041e\u0411\u0415\u0414\u0418\u041b!",
    draw: "\u041d\u0418\u0427\u042c\u042f!",
    congrats: "\u041f\u043e\u0437\u0434\u0440\u0430\u0432\u043b\u044f\u0435\u043c",
    drawSub: "\u041d\u0438\u043a\u0442\u043e \u043d\u0435 \u043f\u043e\u0431\u0435\u0434\u0438\u043b",
    playAgain: "\u21BA \u0421\u043d\u043e\u0432\u0430 \u0438\u0433\u0440\u0430\u0442\u044c",
    restart: "\u21BA \u0420\u0435\u0441\u0442\u0430\u0440\u0442",
    menu: "\u2630 \u041c\u0435\u043d\u044e",
    thinking: "\u0418\u0418 \u0434\u0443\u043c\u0430\u0435\u0442",
    gameTitle: "X \u0438 O"
  },
  en: {
    tagline: "CHOOSE YOUR GAME",
    modeTitle: "GAME MODE",
    pvpLabel: "2 Players",
    pvpDesc: "Play against your friend",
    pveLabel: "vs Computer",
    pveDesc: "Challenge the AI",
    sizeTitle: "BOARD SIZE",
    back: "\u2190 Back",
    playerX: "PLAYER X",
    playerO: "PLAYER O",
    computer: "COMPUTER",
    turnX: "X'S TURN",
    turnO: "O'S TURN",
    xWins: "X WINS!",
    oWins: "O WINS!",
    draw: "DRAW!",
    congrats: "Congratulations",
    drawSub: "No winner this round",
    playAgain: "\u21BA Play Again",
    restart: "\u21BA Restart",
    menu: "\u2630 Menu",
    thinking: "AI thinking",
    gameTitle: "X vs O"
  }
};

// AUDIO
var audioCtx = null, masterGain = null, musicGain = null;
var soundEnabled = true, musicEnabled = true, musicPlaying = false;
var musicTimers = [];

function initAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain(); masterGain.gain.value = 0.7; masterGain.connect(audioCtx.destination);
  musicGain = audioCtx.createGain(); musicGain.gain.value = 0.18; musicGain.connect(masterGain);
}
function resumeAudio() { if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }
function playTone(freq, type, dur, vol, delay, atk, dec) {
  if (!audioCtx || !soundEnabled) return;
  vol=vol||0.3; delay=delay||0; atk=atk||0.01; dec=dec||0.1;
  var t=audioCtx.currentTime+delay, osc=audioCtx.createOscillator(), g=audioCtx.createGain();
  osc.type=type; osc.frequency.setValueAtTime(freq,t);
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+atk); g.gain.exponentialRampToValueAtTime(0.001,t+atk+dec+dur);
  osc.connect(g); g.connect(masterGain); osc.start(t); osc.stop(t+atk+dec+dur+0.05);
}
function playNoise(dur, vol, delay, fc) {
  if (!audioCtx || !soundEnabled) return;
  vol=vol||0.05; delay=delay||0; fc=fc||2000;
  var t=audioCtx.currentTime+delay, sz=Math.ceil(audioCtx.sampleRate*dur);
  var buf=audioCtx.createBuffer(1,sz,audioCtx.sampleRate), d=buf.getChannelData(0);
  for(var i=0;i<sz;i++) d[i]=Math.random()*2-1;
  var src=audioCtx.createBufferSource(), flt=audioCtx.createBiquadFilter(), g=audioCtx.createGain();
  flt.type='bandpass'; flt.frequency.value=fc;
  g.gain.setValueAtTime(vol,t); g.gain.exponentialRampToValueAtTime(0.001,t+dur);
  src.buffer=buf; src.connect(flt); flt.connect(g); g.connect(masterGain); src.start(t); src.stop(t+dur+0.05);
}
function sfxPlaceX() { playTone(330,'sawtooth',0.04,0.2,0,0.005,0.05); playTone(660,'square',0.04,0.15,0.03,0.005,0.06); playTone(990,'sine',0.08,0.25,0.06,0.01,0.1); playNoise(0.05,0.08,0,3000); }
function sfxPlaceO() { playTone(523,'sine',0.12,0.3,0,0.01,0.15); playTone(392,'sine',0.1,0.2,0.05,0.01,0.12); playTone(261,'triangle',0.08,0.15,0.1,0.01,0.1); }
function sfxWin() { [523,659,784,1047].forEach(function(f,i){ playTone(f,'sine',0.15,0.35,i*0.12,0.01,0.2); playTone(f*1.5,'triangle',0.08,0.12,i*0.12+0.05,0.01,0.1); }); playNoise(0.08,0.12,0.58,5000); }
function sfxDraw() { playTone(440,'sine',0.1,0.25,0,0.01,0.15); playTone(370,'sine',0.1,0.2,0.15,0.01,0.15); playTone(330,'triangle',0.2,0.2,0.3,0.01,0.25); }
function sfxNav() { playTone(660,'sine',0.04,0.15,0,0.005,0.06); playTone(880,'sine',0.04,0.12,0.06,0.005,0.06); }
function sfxBack() { playTone(880,'sine',0.04,0.15,0,0.005,0.06); playTone(660,'sine',0.04,0.12,0.06,0.005,0.06); }
function sfxGameStart() { [261,330,392,523].forEach(function(f,i){ playTone(f,'triangle',0.1,0.2,i*0.08,0.01,0.12); }); }

var BPM=90, BEAT=60/BPM;
function startMusic() { if(!audioCtx||!musicEnabled||musicPlaying) return; musicPlaying=true; scheduleMusicLoop(); }
function stopMusic() { musicPlaying=false; musicTimers.forEach(function(t){clearTimeout(t);}); musicTimers=[]; }
function scheduleMusicLoop() { if(!musicPlaying||!musicEnabled) return; playMusicBar(); musicTimers.push(setTimeout(scheduleMusicLoop,BEAT*8*1000)); }
function musicNote(freq,sb,db,vol,type) {
  if(!audioCtx||!musicEnabled) return; vol=vol||0.1; type=type||'sine';
  var t=audioCtx.currentTime+sb*BEAT, osc=audioCtx.createOscillator(), g=audioCtx.createGain();
  osc.type=type; osc.frequency.setValueAtTime(freq,t);
  g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+0.02); g.gain.setValueAtTime(vol*0.7,t+db*BEAT*0.6); g.gain.linearRampToValueAtTime(0,t+db*BEAT);
  osc.connect(g); g.connect(musicGain); osc.start(t); osc.stop(t+db*BEAT+0.05);
}
function playMusicBar() {
  if(!audioCtx||!musicEnabled||!musicPlaying) return;
  [55,55,82,73,55,55,65,61].forEach(function(f,i){musicNote(f,i,0.85,0.14,'triangle');});
  [[220,277,330],[196,247,294],[220,277,370],[185,233,311]].forEach(function(ch,i){ch.forEach(function(f){musicNote(f,i*2,1.8,0.05,'sine');});});
  [440,554,659,880,659,554,440,523,659,784,659,523,440,392,330,440].forEach(function(f,i){musicNote(f,i*0.5,0.4,0.06,'sine');});
  for(var i=0;i<16;i++){ if(i%2===0){ (function(b){ var t2=audioCtx.currentTime+b*BEAT*0.5, sz=Math.ceil(audioCtx.sampleRate*0.04); var buf=audioCtx.createBuffer(1,sz,audioCtx.sampleRate), data=buf.getChannelData(0); for(var j=0;j<sz;j++) data[j]=(Math.random()*2-1)*Math.exp(-j/(sz*0.3)); var src=audioCtx.createBufferSource(), flt=audioCtx.createBiquadFilter(), g2=audioCtx.createGain(); flt.type='highpass'; flt.frequency.value=8000; g2.gain.value=b%4===0?0.12:0.06; src.buffer=buf; src.connect(flt); flt.connect(g2); g2.connect(musicGain); src.start(t2); })(i); } }
  [0,4].forEach(function(b){ var t3=audioCtx.currentTime+b*BEAT, osc=audioCtx.createOscillator(), g3=audioCtx.createGain(); osc.frequency.setValueAtTime(150,t3); osc.frequency.exponentialRampToValueAtTime(40,t3+0.15); g3.gain.setValueAtTime(0.5,t3); g3.gain.exponentialRampToValueAtTime(0.001,t3+0.2); osc.connect(g3); g3.connect(musicGain); osc.start(t3); osc.stop(t3+0.25); });
}
function toggleSound() { soundEnabled=!soundEnabled; document.getElementById('soundBtn').innerHTML=soundEnabled?'&#128266;':'&#128263;'; if(soundEnabled) sfxNav(); }
function toggleMusic() { musicEnabled=!musicEnabled; document.getElementById('musicBtn').style.opacity=musicEnabled?'1':'0.4'; if(musicEnabled){musicPlaying=false;startMusic();}else stopMusic(); }

// STATE
var lang='en', mode='pvp', boardSize=3, board=[], currentPlayer='X', gameOver=false, scores={X:0,O:0}, aiThinking=false;

// NAV
function showScreen(id) { document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');}); document.getElementById(id).classList.add('active'); }
function goBack(screenId) { resumeAudio(); sfxBack(); showScreen(screenId); }
function selectLang(l) { initAudio(); resumeAudio(); sfxNav(); lang=l; applyLang(); showScreen('modeScreen'); setTimeout(startMusic,300); }
function selectMode(m) { sfxNav(); mode=m; showScreen('sizeScreen'); }

function applyLang() {
  var t=T[lang];
  document.getElementById('tagline').textContent=t.tagline;
  document.getElementById('modeTitle').textContent=t.modeTitle;
  document.getElementById('pvpLabel').textContent=t.pvpLabel;
  document.getElementById('pvpDesc').textContent=t.pvpDesc;
  document.getElementById('pveLabel').textContent=t.pveLabel;
  document.getElementById('pveDesc').textContent=t.pveDesc;
  document.getElementById('sizeTitle').textContent=t.sizeTitle;
  document.getElementById('backBtn1').textContent=t.back;
  document.getElementById('backBtn2').textContent=t.back;
  document.getElementById('gameTitle').textContent=t.gameTitle;
  document.getElementById('restartBtn').textContent=t.restart;
  document.getElementById('menuBtn').textContent=t.menu;
  document.getElementById('playAgainBtn').textContent=t.playAgain;
  document.getElementById('thinkingText').textContent=t.thinking;
}

// GAME
function startGame(size) { sfxNav(); boardSize=size; scores={X:0,O:0}; applyLang(); updateScoreLabels(); initBoard(); showScreen('gameScreen'); setTimeout(sfxGameStart,100); }
function initBoard() { board=[]; for(var i=0;i<boardSize*boardSize;i++) board.push(''); currentPlayer='X'; gameOver=false; aiThinking=false; document.getElementById('resultOverlay').classList.remove('show'); document.getElementById('thinking').classList.remove('show'); renderBoard(); updateTurnIndicator(); updateScores(); }
function restartGame() { sfxGameStart(); initBoard(); updateScoreLabels(); }

function renderBoard() {
  var el=document.getElementById('board'); el.className='board size'+boardSize; el.innerHTML='';
  board.forEach(function(val,i){
    var cell=document.createElement('div'); cell.className='cell'+(val?' taken':'');
    cell.onclick=(function(idx){return function(){handleClick(idx);};})(i);
    if(val){ var mark=document.createElement('span'); mark.className='mark '+val.toLowerCase(); mark.textContent=val; cell.appendChild(mark); }
    el.appendChild(cell);
  });
}

function handleClick(idx) { if(gameOver||board[idx]||aiThinking) return; makeMove(idx); }

function makeMove(idx) {
  board[idx]=currentPlayer;
  if(currentPlayer==='X') sfxPlaceX(); else sfxPlaceO();
  renderBoard();
  var winCells=checkWin();
  if(winCells){ highlightWin(winCells); scores[currentPlayer]++; updateScores(); gameOver=true; setTimeout(function(){sfxWin();showResult(currentPlayer+'_WIN');},300); return; }
  if(board.every(function(c){return c!=='';})) { gameOver=true; setTimeout(function(){sfxDraw();showResult('DRAW');},200); return; }
  currentPlayer=currentPlayer==='X'?'O':'X'; updateTurnIndicator();
  if(mode==='pve'&&currentPlayer==='O'){ aiThinking=true; document.getElementById('thinking').classList.add('show'); setTimeout(function(){aiMove();document.getElementById('thinking').classList.remove('show');aiThinking=false;},600+Math.random()*400); }
}

function aiMove() { if(gameOver) return; var idx=boardSize===3?minimax(board.slice(),'O',0).index:aiMove5x5(); if(idx!=null) makeMove(idx); }

function minimax(b,player,depth) {
  var win=checkWinBoard(b,boardSize,false);
  if(win==='O') return{score:10-depth}; if(win==='X') return{score:depth-10};
  var empty=[]; for(var i=0;i<b.length;i++) if(b[i]==='') empty.push(i);
  if(!empty.length) return{score:0};
  if(depth>6) return{score:0,index:empty[Math.floor(Math.random()*empty.length)]};
  var moves=[];
  empty.forEach(function(i){ var nb=b.slice(); nb[i]=player; var r=minimax(nb,player==='O'?'X':'O',depth+1); moves.push({index:i,score:r.score}); });
  return player==='O'?moves.reduce(function(a,b){return b.score>a.score?b:a;}):moves.reduce(function(a,b){return b.score<a.score?b:a;});
}

function aiMove5x5() {
  var empty=[]; for(var i=0;i<board.length;i++) if(board[i]==='') empty.push(i);
  for(var j=0;j<empty.length;j++){var b2=board.slice();b2[empty[j]]='O';if(checkWinBoard(b2,boardSize,false)) return empty[j];}
  for(var k=0;k<empty.length;k++){var b3=board.slice();b3[empty[k]]='X';if(checkWinBoard(b3,boardSize,false)) return empty[k];}
  var ctr=Math.floor(boardSize*boardSize/2); if(!board[ctr]) return ctr;
  var best=-1,bs=-Infinity; empty.forEach(function(i){var s=posScore(i,boardSize);if(s>bs){bs=s;best=i;}}); return best!==-1?best:empty[0];
}
function posScore(i,size){var r=Math.floor(i/size),c=i%size,mid=Math.floor(size/2);return-(Math.abs(r-mid)+Math.abs(c-mid));}
function checkWin(){return checkWinBoard(board,boardSize,true);}
function checkWinBoard(b,size,rc){
  var wl=size===3?3:4,lines=[];
  for(var r=0;r<size;r++) for(var c=0;c<=size-wl;c++){var l=[];for(var k=0;k<wl;k++) l.push(r*size+c+k);lines.push(l);}
  for(var c2=0;c2<size;c2++) for(var r2=0;r2<=size-wl;r2++){var l2=[];for(var k2=0;k2<wl;k2++) l2.push((r2+k2)*size+c2);lines.push(l2);}
  for(var r3=0;r3<=size-wl;r3++) for(var c3=0;c3<=size-wl;c3++){var l3=[];for(var k3=0;k3<wl;k3++) l3.push((r3+k3)*size+(c3+k3));lines.push(l3);}
  for(var r4=0;r4<=size-wl;r4++) for(var c4=wl-1;c4<size;c4++){var l4=[];for(var k4=0;k4<wl;k4++) l4.push((r4+k4)*size+(c4-k4));lines.push(l4);}
  for(var li=0;li<lines.length;li++){var vals=lines[li].map(function(i){return b[i];});if(vals[0]&&vals.every(function(v){return v===vals[0];})) return rc?lines[li]:vals[0];}
  return null;
}
function highlightWin(cells){var ce=document.getElementById('board').children;cells.forEach(function(i){ce[i].classList.add('winning');});}
function updateTurnIndicator(){var t=T[lang],el=document.getElementById('turnIndicator');el.className='turn-indicator '+currentPlayer.toLowerCase()+'-turn';el.textContent=currentPlayer==='X'?t.turnX:t.turnO;}
function updateScoreLabels(){var t=T[lang];document.getElementById('playerXLabel').textContent=t.playerX;document.getElementById('playerOLabel').textContent=mode==='pve'?t.computer:t.playerO;}
function updateScores(){document.getElementById('scoreX').textContent=scores.X;document.getElementById('scoreO').textContent=scores.O;}
function showResult(type){
  var t=T[lang],overlay=document.getElementById('resultOverlay'),text=document.getElementById('resultText'),sub=document.getElementById('resultSub');
  overlay.classList.add('show');
  if(type==='X_WIN'){text.textContent=t.xWins;text.className='result-text x-win';sub.textContent=t.congrats;}
  else if(type==='O_WIN'){text.textContent=t.oWins;text.className='result-text o-win';sub.textContent=t.congrats;}
  else{text.textContent=t.draw;text.className='result-text draw';sub.textContent=t.drawSub;}
}
</script>
</body>
</html>