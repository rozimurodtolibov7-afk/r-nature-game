<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-Nature World</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; overflow: hidden; }
        
        /* ASOSIY OQ FON */
        #game-container { width: 100%; height: 100vh; background: #ffffff; position: relative; }
        
        /* UI ELEMENTLARI */
        .top-bar { position: absolute; top: 20px; left: 20px; z-index: 100; display: flex; gap: 10px; }
        .pill { background: #fff; padding: 10px 18px; border-radius: 30px; border: 2px solid #ffcc00; display: flex; align-items: center; gap: 8px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        /* MENYU */
        #menu-screen, #lang-screen { position: fixed; inset: 0; background: #ffffff; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .play-btn { width: 140px; height: 140px; background: #ffcc00; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 900; color: #fff; border: 8px solid #f0f2f5; cursor: pointer; margin-bottom: 30px; box-shadow: 0 10px 20px rgba(255, 204, 0, 0.3); }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .btn { background: #007aff; color: #fff; padding: 18px; border-radius: 20px; border: none; font-weight: 600; font-size: 15px; }

        /* O'SIMLIKLAR */
        .plant { position: absolute; transform: translate(-50%, -100%); text-align: center; cursor: pointer; transition: 0.3s; }
        .profit { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); background: #28a745; color: #fff; padding: 4px 10px; border-radius: 10px; font-size: 14px; animation: float 1s infinite; }
        .bird { position: absolute; font-size: 40px; z-index: 50; transition: 4s linear; }

        #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center; }
        .modal { background: #fff; width: 90%; border-radius: 30px; padding: 25px; max-height: 70vh; overflow-y: auto; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        
        @keyframes float { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -10px); } }
    </style>
</head>
<body>

<div id="game-container">
    <div id="lang-screen">
        <h1 style="margin-bottom: 30px;">Language</h1>
        <div id="lang-list" class="grid-container"></div>
    </div>

    <div id="menu-screen" style="display:none">
        <div class="play-btn" onclick="startGame()">PLAY</div>
        <div class="grid-container">
            <button class="btn" onclick="openShop()">üõí Shop</button>
            <button class="btn" onclick="openRank()">üèÜ Rank</button>
            <button class="btn" onclick="openInv()">üéí Bag</button>
            <button class="btn" onclick="invite()">üë• Invite</button>
        </div>
    </div>

    <div id="play-area" style="display:none; width: 100%; height: 100%;">
        <div class="top-bar">
            <div class="pill" onclick="location.reload()">üè†</div>
            <div class="pill">üí∞ <span id="bal-val">50.00</span></div>
        </div>
        <div id="garden" style="width: 100%; height: 100%;"></div>
    </div>

    <div id="modal-overlay">
        <div class="modal">
            <h2 id="modal-title" style="text-align: center; margin-bottom: 20px;"></h2>
            <div id="modal-body"></div>
            <button onclick="closeModal()" style="width:100%; margin-top:20px; padding:15px; border-radius:15px; background:#ff3b30; color:#fff; border:none; font-weight:bold;">Close</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBK57eb0Wr_x2x-PFC-a5PAzqBzdKMeic",
        authDomain: "r-nature.firebaseapp.com",
        projectId: "r-nature",
        databaseURL: "https://r-nature-default-rtdb.firebaseio.com/",
        storageBucket: "r-nature.firebasestorage.app",
        messagingSenderId: "504684708516",
        appId: "1:504684708516:web:c4545ae8a8b94bc0391c31"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tg = window.Telegram.WebApp;
    const uid = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "dev_user";

    let state = { bal: 50.0, lang: 'uz', inv: {"Rose": 1}, planted: [], hasSuperman: false, name: tg.initDataUnsafe.user?.first_name || "User" };
    let currentSeed = null;

    const shopItems = [
        { id: "Rose", n: "Atirgul", p: 10, i: "üåπ", t: 60 }, 
        { id: "Kaktus", n: "Kaktus", p: 20, i: "üåµ", t: 120 },
        { id: "Sunflower", n: "Kungaboqar", p: 50, i: "üåª", t: 300 },
        { id: "Superman", n: "Robot Superman", p: 10000, i: "ü¶∏‚Äç‚ôÇÔ∏è", special: true },
        { id: "MagicTree", n: "Sehrli Daraxt", p: 100000, i: "‚ú®üå≥", t: 3600 }
    ];

    const langs = { uz:"O'zbek", en:"English", ru:"–†—É—Å—Å–∫–∏–π", tr:"T√ºrk√ße", tj:"–¢–æ“∑–∏–∫”£", de:"Deutsch", fr:"Fran√ßais", es:"Espa√±ol", pt:"Portugu√™s", it:"Italiano" };

    function init() {
        const lDiv = document.getElementById('lang-list');
        Object.keys(langs).forEach(k => {
            const b = document.createElement('button'); b.className = 'btn';
            b.innerText = langs[k]; b.onclick = () => { state.lang = k; save(); showMenu(); };
            lDiv.appendChild(b);
        });
        db.ref('users/'+uid).once('value', s => { if(s.exists()){ state = s.val(); if(state.lang) showMenu(); }});
    }

    function showMenu() {
        document.getElementById('lang-screen').style.display = 'none';
        document.getElementById('menu-screen').style.display = 'flex';
        document.getElementById('bal-val').innerText = state.bal.toFixed(2);
    }

    function startGame() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('play-area').style.display = 'block';
        renderGarden();
    }

    function openShop() {
        document.getElementById('modal-title').innerText = "Shop";
        let h = "";
        shopItems.forEach(it => {
            h += `<div class="item"><span>${it.i} ${it.n} (${it.p} RC)</span><button class="btn" style="padding:8px 15px" onclick="buy('${it.id}')">Buy</button></div>`;
        });
        document.getElementById('modal-body').innerHTML = h;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function openInv() {
        document.getElementById('modal-title').innerText = "Inventory";
        let h = "";
        for(let k in state.inv) {
            if(state.inv[k] > 0) {
                const it = shopItems.find(x => x.id === k);
                h += `<div class="item"><span>${it.i} ${it.n} (${state.inv[k]})</span><button class="btn" style="background:#28a745; padding:8px 15px" onclick="pick('${k}')">Sow</button></div>`;
            }
        }
        document.getElementById('modal-body').innerHTML = h || "Empty";
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function openRank() {
        db.ref('users').orderByChild('bal').limitToLast(10).once('value', s => {
            let list = []; s.forEach(c => list.push(c.val()));
            list.sort((a,b) => b.bal - a.bal);
            document.getElementById('modal-title').innerText = "Rank";
            document.getElementById('modal-body').innerHTML = list.map((u,i) => `<div class="item"><b>${i+1}. ${u.name}</b> <span>${u.bal.toFixed(0)} RC</span></div>`).join('');
            document.getElementById('modal-overlay').style.display = 'flex';
        });
    }

    window.buy = (id) => {
        const it = shopItems.find(x => x.id === id);
        if(state.bal >= it.p) {
            state.bal -= it.p;
            if(id === "Superman") state.hasSuperman = true;
            else state.inv[id] = (state.inv[id] || 0) + 1;
            save(); updateBal();
        } else alert("No RC!");
    };

    window.pick = (id) => { currentSeed = id; closeModal(); };

    document.getElementById('garden').onclick = (e) => {
        if(!currentSeed || !state.inv[currentSeed]) return;
        const it = shopItems.find(x => x.id === currentSeed);
        const p = { x: e.clientX, y: e.clientY, id: it.id, t: Date.now() };
        state.planted.push(p); state.inv[currentSeed]--;
        renderPlant(p); save(); updateBal();
    };

    function renderPlant(p) {
        const it = shopItems.find(x => x.id === p.id);
        const div = document.createElement('div'); div.className = 'plant'; div.id = 'p-'+p.t;
        div.style.left = p.x + 'px'; div.style.top = p.y + 'px';
        const age = (Date.now() - p.t) / 1000;
        if(age >= it.t) {
            div.innerHTML = `<div class="profit">+${it.p*2}</div>${it.i}`;
            div.onclick = (e) => { e.stopPropagation(); collect(p.t); };
        } else { div.innerText = age > it.t/2 ? "üå±" : "ü´ò"; }
        document.getElementById('garden').appendChild(div);
    }

    function collect(tid) {
        const idx = state.planted.findIndex(x => x.t === tid);
        const p = state.planted[idx];
        const it = shopItems.find(x => x.id === p.id);
        state.bal += (it.p * 2);
        state.planted.splice(idx, 1);
        document.getElementById('p-'+tid).remove();
        save(); updateBal();
    }

    function spawnBird() {
        if(state.hasSuperman || state.planted.length === 0) return;
        const b = document.createElement('div'); b.className = 'bird'; b.innerText = "ü¶Ö";
        b.style.top = Math.random()*80+"%"; b.style.left = "-50px";
        document.body.appendChild(b);
        setTimeout(() => { b.style.left = "110%"; setTimeout(() => { if(b.parentNode){ state.bal = Math.max(0, state.bal-5); updateBal(); b.remove(); }}, 2000); }, 100);
        b.onclick = () => b.remove();
    }

    function save() { db.ref('users/'+uid).set(state); }
    function updateBal() { document.getElementById('bal-val').innerText = state.bal.toFixed(2); }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function renderGarden() { document.getElementById('garden').innerHTML = ''; state.planted.forEach(renderPlant); }
    function invite() { tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/RPlay_game_bot&text=Join me!`); }

    setInterval(renderGarden, 5000);
    setInterval(spawnBird, 20000);
    init();
</script>
</body>
</html>